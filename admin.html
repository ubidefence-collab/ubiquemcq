<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - UBIQUE MCQ</title>
<link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&family=Baloo+Da+2:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --primary: #4F46E5;
  --primary-dark: #3730A3;
  --primary-light: #818CF8;
  --accent: #F59E0B;
  --success: #10B981;
  --danger: #EF4444;
  --warning: #F97316;
  --bg: #0F0E1A;
  --sidebar: #161528;
  --card: #1E1C35;
  --border: #2D2B4E;
  --text: #E8E6FF;
  --text-muted: #8B89B0;
  --shadow: 0 4px 24px rgba(0,0,0,0.4);
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: 'Hind Siliguri', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

/* SIDEBAR */
.sidebar {
  width: 240px; min-height: 100vh;
  background: var(--sidebar);
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
  position: fixed; top:0; left:0; bottom:0;
  z-index: 100;
}
.sidebar-logo {
  padding: 1.5rem 1.2rem;
  font-family: 'Baloo Da 2', cursive;
  font-size: 1.3rem; font-weight: 800;
  color: var(--primary-light);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 0.5rem;
}
.sidebar-label {
  font-size: 0.7rem; font-weight: 600;
  color: var(--text-muted); text-transform: uppercase;
  letter-spacing: 1px; padding: 1rem 1.2rem 0.4rem;
}
.nav-item {
  display: flex; align-items: center; gap: 0.7rem;
  padding: 0.7rem 1.2rem;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.2s;
  border-left: 3px solid transparent;
  font-size: 0.92rem;
  font-weight: 500;
}
.nav-item:hover { background: rgba(79,70,229,0.1); color: var(--text); }
.nav-item.active { background: rgba(79,70,229,0.15); color: var(--primary-light); border-left-color: var(--primary-light); }
.nav-icon { font-size: 1.1rem; }
.sidebar-bottom { margin-top: auto; padding: 1rem 1.2rem; border-top: 1px solid var(--border); }
.admin-info { font-size: 0.82rem; color: var(--text-muted); margin-bottom: 0.6rem; }
.btn-logout-admin {
  width: 100%; padding: 0.5rem;
  background: rgba(239,68,68,0.15);
  border: 1px solid rgba(239,68,68,0.3);
  color: #FCA5A5;
  border-radius: 8px;
  cursor: pointer;
  font-family: 'Hind Siliguri', sans-serif;
  font-size: 0.85rem; font-weight: 600;
  transition: all 0.2s;
}
.btn-logout-admin:hover { background: rgba(239,68,68,0.25); }

/* MAIN */
.main { margin-left: 240px; padding: 2rem; min-height: 100vh; }
.page-header {
  margin-bottom: 1.8rem;
  display: flex; align-items: center; justify-content: space-between;
}
.page-header h1 { font-family: 'Baloo Da 2', cursive; font-size: 1.6rem; font-weight: 700; }
.page-header p { color: var(--text-muted); font-size: 0.9rem; margin-top: 0.2rem; }

/* CARDS */
.card {
  background: var(--card);
  border-radius: 16px;
  border: 1px solid var(--border);
  padding: 1.5rem;
  box-shadow: var(--shadow);
}
.stat-grid { display: grid; grid-template-columns: repeat(4,minmax(0,1fr)); gap: 1rem; margin-bottom: 1.5rem; width: 100%; }
.stat-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 1.2rem;
  display: flex; flex-direction: column; gap: 0.3rem;
}
.stat-card-val { font-size: 2rem; font-weight: 800; font-family: 'Baloo Da 2', cursive; }
.stat-card-label { font-size: 0.82rem; color: var(--text-muted); }
.stat-c1 .stat-card-val { color: var(--primary-light); }
.stat-c2 .stat-card-val { color: var(--success); }
.stat-c3 .stat-card-val { color: var(--accent); }
.stat-c4 .stat-card-val { color: #F472B6; }

/* TABLE */
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; }
th {
  background: rgba(79,70,229,0.15);
  padding: 0.7rem 1rem;
  text-align: left; font-size: 0.78rem;
  font-weight: 700; color: var(--primary-light);
  text-transform: uppercase; letter-spacing: 0.5px;
  white-space: nowrap;
}
td {
  padding: 0.65rem 1rem;
  font-size: 0.88rem;
  border-bottom: 1px solid rgba(255,255,255,0.04);
  color: var(--text);
}
tr:hover td { background: rgba(79,70,229,0.06); }

/* FORMS */
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
.form-group { margin-bottom: 1rem; }
.form-label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.4rem; }
.form-control {
  width: 100%; padding: 0.65rem 0.9rem;
  background: #2D2B4E;
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text);
  font-family: 'Hind Siliguri', sans-serif;
  font-size: 0.92rem;
  transition: all 0.2s;
}
.form-control:focus { outline: none; border-color: var(--primary-light); background: #3730A3; }
textarea.form-control { min-height: 80px; resize: vertical; }
.form-control option {
  background: #2D2B4E;
  color: var(--text);
}

/* BUTTONS */
.btn {
  padding: 0.55rem 1.2rem;
  border-radius: 10px; border: none;
  font-family: 'Hind Siliguri', sans-serif;
  font-size: 0.88rem; font-weight: 600;
  cursor: pointer; transition: all 0.2s;
  display: inline-flex; align-items: center; gap: 0.4rem;
}
.btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: #fff; }
.btn-primary:hover { box-shadow: 0 4px 12px rgba(79,70,229,0.4); transform: translateY(-1px); }
.btn-success { background: linear-gradient(135deg, var(--success), #059669); color: #fff; }
.btn-success:hover { box-shadow: 0 4px 12px rgba(16,185,129,0.4); }
.btn-danger { background: rgba(239,68,68,0.15); color: #FCA5A5; border: 1px solid rgba(239,68,68,0.3); }
.btn-danger:hover { background: rgba(239,68,68,0.25); }
.btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
.btn-ghost:hover { border-color: var(--primary-light); color: var(--primary-light); }
.btn-sm { padding: 0.3rem 0.75rem; font-size: 0.78rem; }

/* BADGE */
.badge {
  display: inline-block; padding: 0.2rem 0.6rem;
  border-radius: 20px; font-size: 0.72rem; font-weight: 600;
}
.badge-active { background: rgba(16,185,129,0.15); color: #34D399; }
.badge-inactive { background: rgba(239,68,68,0.15); color: #FCA5A5; }
.badge-class { background: rgba(79,70,229,0.2); color: var(--primary-light); }

/* SECTION TABS */
.section { display: none; }
.section.active { display: block; }

/* MODAL */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.7);
  display: none; align-items: center; justify-content: center;
  z-index: 200; padding: 1rem;
}
.modal-overlay.active { display: flex; }
.modal {
  background: var(--card); border-radius: 20px;
  padding: 1.8rem; width: 100%; max-width: 560px;
  border: 1px solid var(--border); box-shadow: var(--shadow);
  max-height: 90vh; overflow-y: auto;
}
.modal h3 { font-size: 1.1rem; font-weight: 700; margin-bottom: 1.2rem; color: var(--primary-light); }
.modal-footer { display: flex; gap: 0.8rem; justify-content: flex-end; margin-top: 1rem; }

/* Q LIST */
.q-item {
  background: rgba(255,255,255,0.04);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 1rem;
  margin-bottom: 0.8rem;
}
.q-item-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
.q-item-text { font-size: 0.9rem; margin-bottom: 0.5rem; }
.q-item-options { display: grid; grid-template-columns: 1fr 1fr; gap: 0.3rem; font-size: 0.8rem; color: var(--text-muted); }
.q-correct { color: var(--success); font-weight: 600; }

/* LOGIN */
.admin-login-wrap {
  min-height: 100vh; display: flex; align-items: center; justify-content: center;
  background: var(--bg);
}
.admin-login-card {
  background: var(--card); border-radius: 20px; padding: 2.5rem;
  width: 100%; max-width: 380px; border: 1px solid var(--border);
}
.admin-login-card h2 {
  font-family: 'Baloo Da 2', cursive; font-size: 1.5rem;
  font-weight: 700; margin-bottom: 1.5rem; color: var(--primary-light);
  text-align: center;
}

/* LOADING */
.loading-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.6);
  display: none; align-items: center; justify-content: center; z-index: 999;
}
.spinner { width: 44px; height: 44px; border: 4px solid rgba(255,255,255,0.15); border-top-color: var(--primary-light); border-radius: 50%; animation: spin 0.7s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

.alert {
  padding: 0.7rem 1rem; border-radius: 10px; font-size: 0.88rem;
  margin-bottom: 1rem; display: none;
}
.alert-error { background: rgba(239,68,68,0.15); color: #FCA5A5; border: 1px solid rgba(239,68,68,0.3); }
.alert-success { background: rgba(16,185,129,0.15); color: #34D399; border: 1px solid rgba(16,185,129,0.3); }

/* тФАтФА MOBILE HAMBURGER BUTTON тФАтФА */
.hamburger {
  display: none;
  position: fixed; top: 0; left: 0; right: 0; z-index: 300;
  background: var(--sidebar);
  border-bottom: 1px solid var(--border);
  padding: 0.75rem 1rem;
  align-items: center; gap: 0.7rem;
  font-size: 1rem; font-weight: 700;
  color: var(--primary-light);
  font-family: 'Baloo Da 2', cursive;
}
.hamburger-icon {
  background: rgba(255,255,255,0.1);
  border: 1px solid var(--border);
  border-radius: 8px; padding: 0.3rem 0.55rem;
  cursor: pointer; font-size: 1.1rem; color: var(--text);
  line-height: 1;
}
.sidebar-overlay {
  display: none;
  position: fixed; inset: 0; background: rgba(0,0,0,0.7);
  z-index: 150;
}
.sidebar-overlay.active { display: block; }

/* тФАтФА RESPONSIVE тФАтФА */

/* Tablet */
@media(max-width: 900px) {
  .stat-grid { grid-template-columns: repeat(2, 1fr); }
  .form-row { grid-template-columns: 1fr; gap: 0; }
}

/* Mobile */
@media(max-width: 640px) {

  /* Show hamburger bar at top */
  .hamburger { display: flex; }

  body { overflow-x: hidden; }

  /* Sidebar hidden off-screen by default */
  .sidebar {
    transform: translateX(-100%);
    z-index: 250;
    width: 240px;
  }
  .sidebar.open { transform: translateX(0); }

  /* Main full width, pushed below hamburger bar */
  .main {
    margin-left: 0 !important;
    padding: 1rem 0.8rem;
    padding-top: 4rem;
    width: 100%;
    box-sizing: border-box;
  }

  /* Login card */
  .admin-login-card { padding: 1.8rem 1.2rem; margin: 1rem; }

  /* Page header */
  .page-header {
    flex-wrap: wrap;
    gap: 0.7rem;
    margin-bottom: 1.2rem;
  }
  .page-header h1 { font-size: 1.2rem; }
  .page-header > div:last-child {
    display: flex; flex-wrap: wrap; gap: 0.5rem; width: 100%;
  }
  .page-header .btn { flex: 1; justify-content: center; font-size: 0.8rem; padding: 0.5rem 0.7rem; }

  /* Stats grid */
  .stat-grid { grid-template-columns: repeat(2, minmax(0,1fr)); gap: 0.6rem; margin-bottom: 1rem; }
  .stat-card { padding: 0.9rem; border-radius: 12px; }
  .stat-card-val { font-size: 1.6rem; }
  .stat-card-label { font-size: 0.75rem; }

  /* Cards */
  .card { padding: 1rem; border-radius: 12px; }

  /* Tables */
  .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  table { font-size: 0.78rem; min-width: 500px; }
  th { padding: 0.5rem 0.7rem; font-size: 0.68rem; }
  td { padding: 0.5rem 0.7rem; }

  /* Filter rows */
  .filter-row {
    display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.8rem;
  }
  .filter-row .form-control { font-size: 0.82rem; padding: 0.5rem 0.7rem; }

  /* Forms */
  .form-row { grid-template-columns: 1fr; gap: 0; }
  .form-control { font-size: 0.88rem; padding: 0.6rem 0.8rem; }
  textarea.form-control { min-height: 70px; }

  /* Modal */
  .modal {
    padding: 1.3rem;
    border-radius: 16px;
    max-height: 85vh;
  }
  .modal h3 { font-size: 1rem; margin-bottom: 1rem; }
  .modal-footer { flex-wrap: wrap; }
  .modal-footer .btn { flex: 1; justify-content: center; }

  /* Buttons */
  .btn { font-size: 0.82rem; padding: 0.5rem 0.9rem; }
  .btn-sm { font-size: 0.72rem; padding: 0.28rem 0.6rem; }

  /* Question list */
  .q-item { padding: 0.8rem; }
  .q-item-text { font-size: 0.83rem; }
  .q-item-options { grid-template-columns: 1fr; gap: 0.2rem; font-size: 0.75rem; }

  /* Section filter dropdowns */
  div[style*="display:flex"][style*="gap"] .form-control[style*="width:auto"] {
    width: 100% !important;
  }
}
</style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>

<!-- Mobile top bar (hidden on desktop) -->
<div class="hamburger" id="hamburgerBtn">
  <span class="hamburger-icon" onclick="toggleSidebar()">тШ░</span>
  <span>тЪб UBIQUE Admin</span>
</div>
<!-- Sidebar overlay -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<!-- ADMIN LOGIN -->
<div id="adminLoginWrap" class="admin-login-wrap">
  <div class="admin-login-card">
    <h2>ЁЯФР Admin Login</h2>
    <div class="form-group">
      <label class="form-label">Username</label>
      <input class="form-control" id="adminUser" type="text" placeholder="admin">
    </div>
    <div class="form-group">
      <label class="form-label">Password</label>
      <input class="form-control" id="adminPass" type="password" placeholder="тАвтАвтАвтАвтАвтАвтАвтАв">
    </div>
    <div class="alert alert-error" id="adminLoginError"></div>
    <button class="btn btn-primary" style="width:100%;justify-content:center;padding:0.75rem" onclick="adminLogin()">рж▓ржЧрж┐ржи ржХрж░рзБржи</button>
  </div>
</div>

<!-- MAIN APP -->
<div id="adminApp" style="display:none; width:100%">

<!-- SIDEBAR -->
<nav class="sidebar" id="sidebar">
  <div class="sidebar-logo">тЪб UBIQUE Admin</div>
  <div class="sidebar-label">ржорзВрж▓ ржорзЗржирзБ</div>
  <div class="nav-item active" onclick="showSection('dashboard',this)"><span class="nav-icon">ЁЯУК</span> ржбрзНржпрж╛рж╢ржмрзЛрж░рзНржб</div>
  <div class="nav-item" onclick="showSection('students',this)"><span class="nav-icon">ЁЯСитАНЁЯОУ</span> рж╢рж┐ржХрзНрж╖рж╛рж░рзНржерзА</div>
  <div class="nav-item" onclick="showSection('exams',this)"><span class="nav-icon">ЁЯУЛ</span> ржкрж░рзАржХрзНрж╖рж╛</div>
  <div class="nav-item" onclick="showSection('questions',this)"><span class="nav-icon">тЭУ</span> ржкрзНрж░рж╢рзНржирж╕ржорзВрж╣</div>
  <div class="nav-item" onclick="showSection('results',this)"><span class="nav-icon">ЁЯУИ</span> ржлрж▓рж╛ржлрж▓</div>
  <div class="nav-item" onclick="showSection('merit',this)"><span class="nav-icon">ЁЯПЖ</span> ржорзЗрж░рж┐ржЯ рж▓рж┐рж╕рзНржЯ</div>
  <div class="sidebar-bottom">
    <div class="admin-info">Admin рж╣рж┐рж╕рзЗржмрзЗ рж▓ржЧрж┐ржи ржХрж░рж╛ ржЖржЫрзЗржи</div>
    <button class="btn-logout-admin" onclick="adminLogout()">ЁЯЪк рж▓ржЧржЖржЙржЯ</button>
  </div>
</nav>

<!-- MAIN CONTENT -->
<main class="main">

  <!-- DASHBOARD -->
  <div class="section active" id="sec-dashboard">
    <div class="page-header">
      <div><h1>ЁЯУК ржбрзНржпрж╛рж╢ржмрзЛрж░рзНржб</h1><p>рж╕рж╛ржоржЧрзНрж░рж┐ржХ ржкрж░рж┐рж╕ржВржЦрзНржпрж╛ржи</p></div>
    </div>
    <div class="stat-grid">
      <div class="stat-card stat-c1"><div class="stat-card-val" id="totalStudents">-</div><div class="stat-card-label">ржорзЛржЯ рж╢рж┐ржХрзНрж╖рж╛рж░рзНржерзА</div></div>
      <div class="stat-card stat-c2"><div class="stat-card-val" id="totalExams">-</div><div class="stat-card-label">ржорзЛржЯ ржкрж░рзАржХрзНрж╖рж╛</div></div>
      <div class="stat-card stat-c3"><div class="stat-card-val" id="totalQuestions">-</div><div class="stat-card-label">ржорзЛржЯ ржкрзНрж░рж╢рзНржи</div></div>
      <div class="stat-card stat-c4"><div class="stat-card-val" id="totalResults">-</div><div class="stat-card-label">ржорзЛржЯ ржкрж░рзАржХрзНрж╖рж╛рж░рзНржерзА</div></div>
    </div>
    <div class="card">
      <h3 style="font-size:1rem;font-weight:700;margin-bottom:1rem;color:var(--primary-light)">ЁЯУЛ рж╕рж╛ржорзНржкрзНрж░рждрж┐ржХ ржлрж▓рж╛ржлрж▓</h3>
      <div class="table-wrap" id="recentResultsTable">рж▓рзЛржб рж╣ржЪрзНржЫрзЗ...</div>
    </div>
  </div>

  <!-- STUDENTS -->
  <div class="section" id="sec-students">
    <div class="page-header">
      <div><h1>ЁЯСитАНЁЯОУ рж╢рж┐ржХрзНрж╖рж╛рж░рзНржерзА</h1><p>рж╕ржХрж▓ рж╢рж┐ржХрзНрж╖рж╛рж░рзНржерзАрж░ рждржерзНржп</p></div>
      <div style="display:flex;gap:0.6rem">
        <button class="btn btn-ghost" onclick="openModal('bulkImportModal')">ЁЯУе CSV Import</button>
        <button class="btn btn-primary" onclick="openModal('addStudentModal')">+ ржирждрзБржи рж╢рж┐ржХрзНрж╖рж╛рж░рзНржерзА</button>
      </div>
    </div>
    <div class="card">
      <div class="filter-row" style="display:flex;gap:0.8rem;margin-bottom:1rem;flex-wrap:wrap">
        <select class="form-control" id="filterClass" style="width:auto;flex:1;min-width:120px" onchange="loadStudents()">
          <option value="">рж╕ржм ржХрзНрж▓рж╛рж╕</option>
          <option value="6">ржХрзНрж▓рж╛рж╕ рзм</option><option value="7">ржХрзНрж▓рж╛рж╕ рзн</option>
          <option value="8">ржХрзНрж▓рж╛рж╕ рзо</option><option value="9">ржХрзНрж▓рж╛рж╕ рзп</option>
          <option value="10">ржХрзНрж▓рж╛рж╕ рззрзж</option>
        </select>
        <select class="form-control" id="filterBatch" style="width:auto;flex:1;min-width:120px" onchange="loadStudents()">
          <option value="">рж╕ржм ржмрзНржпрж╛ржЪ</option>
          <option value="A">Batch A</option>
          <option value="B">Batch B</option>
          <option value="C">Batch C</option>
          <option value="D">Batch D</option>
          <option value="E">Batch E</option>
        </select>
      </div>
      <div class="table-wrap" id="studentsTable">рж▓рзЛржб рж╣ржЪрзНржЫрзЗ...</div>
    </div>
  </div>

  <!-- EXAMS -->
  <div class="section" id="sec-exams">
    <div class="page-header">
      <div><h1>ЁЯУЛ ржкрж░рзАржХрзНрж╖рж╛</h1><p>ржкрж░рзАржХрзНрж╖рж╛ рждрзИрж░рж┐ ржУ ржкрж░рж┐ржЪрж╛рж▓ржирж╛</p></div>
      <button class="btn btn-primary" onclick="openModal('addExamModal')">+ ржирждрзБржи ржкрж░рзАржХрзНрж╖рж╛</button>
    </div>
    <div class="card">
      <div class="table-wrap" id="examsTable">рж▓рзЛржб рж╣ржЪрзНржЫрзЗ...</div>
    </div>
  </div>

  <!-- QUESTIONS -->
  <div class="section" id="sec-questions">
    <div class="page-header">
      <div><h1>тЭУ ржкрзНрж░рж╢рзНржирж╕ржорзВрж╣</h1><p>ржкрж░рзАржХрзНрж╖рж╛ ржЕржирзБржпрж╛ржпрж╝рзА ржкрзНрж░рж╢рзНржи ржжрзЗржЦрзБржи ржУ ржпрзЛржЧ ржХрж░рзБржи</p></div>
    </div>
    <div class="card" style="margin-bottom:1rem">
      <div style="display:flex;gap:0.8rem;align-items:center;flex-wrap:wrap">
        <select class="form-control" id="qExamFilter" style="width:auto" onchange="loadQuestions()">
          <option value="">ржкрж░рзАржХрзНрж╖рж╛ ржмрзЗржЫрзЗ ржирж┐ржи</option>
        </select>
        <button class="btn btn-primary btn-sm" id="addQBtn" onclick="openAddQuestion()" style="display:none">+ ржкрзНрж░рж╢рзНржи ржпрзЛржЧ</button>
      </div>
    </div>
    <div id="questionsList">ржкрж░рзАржХрзНрж╖рж╛ ржмрзЗржЫрзЗ ржирж┐ржи</div>
  </div>

  <!-- RESULTS -->
  <div class="section" id="sec-results">
    <div class="page-header">
      <div><h1>ЁЯУИ ржлрж▓рж╛ржлрж▓</h1><p>рж╕ржХрж▓ ржкрж░рзАржХрзНрж╖рж╛рж░ ржлрж▓рж╛ржлрж▓</p></div>
    </div>
    <div class="card">
      <div class="filter-row" style="display:flex;gap:0.8rem;margin-bottom:1rem;flex-wrap:wrap">
        <select class="form-control" id="resultExamFilter" style="flex:2;min-width:160px" onchange="loadResults()">
          <option value="">рж╕ржм ржкрж░рзАржХрзНрж╖рж╛</option>
        </select>
        <select class="form-control" id="resultClassFilter" style="flex:1;min-width:110px" onchange="loadResults()">
          <option value="">рж╕ржм ржХрзНрж▓рж╛рж╕</option>
          <option value="6">ржХрзНрж▓рж╛рж╕ рзм</option><option value="7">ржХрзНрж▓рж╛рж╕ рзн</option>
          <option value="8">ржХрзНрж▓рж╛рж╕ рзо</option><option value="9">ржХрзНрж▓рж╛рж╕ рзп</option>
          <option value="10">ржХрзНрж▓рж╛рж╕ рззрзж</option>
        </select>
      </div>
      <div class="table-wrap" id="resultsTable">рж▓рзЛржб рж╣ржЪрзНржЫрзЗ...</div>
    </div>
  </div>

  <!-- MERIT -->
  <div class="section" id="sec-merit">
    <div class="page-header">
      <div><h1>ЁЯПЖ ржорзЗрж░рж┐ржЯ рж▓рж┐рж╕рзНржЯ</h1><p>ржорж╛рж╕рж┐ржХ ржорзЗрж░рж┐ржЯ ржкржЬрж┐рж╢ржи</p></div>
    </div>
    <div class="card">
      <div class="filter-row" style="display:flex;gap:0.8rem;margin-bottom:1rem;flex-wrap:wrap">
        <select class="form-control" id="meritClassFilter" style="flex:1;min-width:110px" onchange="loadAdminMerit()">
          <option value="6">ржХрзНрж▓рж╛рж╕ рзм</option><option value="7">ржХрзНрж▓рж╛рж╕ рзн</option>
          <option value="8">ржХрзНрж▓рж╛рж╕ рзо</option><option value="9">ржХрзНрж▓рж╛рж╕ рзп</option>
          <option value="10">ржХрзНрж▓рж╛рж╕ рззрзж</option>
        </select>
        <select class="form-control" id="meritBatchFilter" style="flex:1;min-width:110px" onchange="loadAdminMerit()">
          <option value="A">Batch A</option>
          <option value="B">Batch B</option>
          <option value="C">Batch C</option>
          <option value="D">Batch D</option>
          <option value="E">Batch E</option>
        </select>
        <select class="form-control" id="meritMonthFilter" style="flex:1;min-width:140px" onchange="loadAdminMerit()">
          <option value="February 2026">ржлрзЗржмрзНрж░рзБржпрж╝рж╛рж░рж┐ рзирзжрзирзм</option>
          <option value="March 2026">ржорж╛рж░рзНржЪ рзирзжрзирзм</option>
        </select>
      </div>
      <div class="table-wrap" id="meritTable">рж▓рзЛржб рж╣ржЪрзНржЫрзЗ...</div>
    </div>
  </div>

</main>
</div>

<!-- тФАтФА MODALS тФАтФА -->

<!-- Add Student -->
<div class="modal-overlay" id="addStudentModal">
  <div class="modal">
    <h3>тЮХ ржирждрзБржи рж╢рж┐ржХрзНрж╖рж╛рж░рзНржерзА ржпрзЛржЧ ржХрж░рзБржи</h3>
    <div class="alert alert-error" id="addStudentError"></div>
    <div class="alert alert-success" id="addStudentSuccess"></div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">ржирж╛ржо</label>
        <input class="form-control" id="sName" placeholder="рж╢рж┐ржХрзНрж╖рж╛рж░рзНржерзАрж░ ржирж╛ржо">
      </div>
      <div class="form-group">
        <label class="form-label">ржХрзНрж▓рж╛рж╕</label>
        <select class="form-control" id="sClass">
          <option value="6">рзм</option><option value="7">рзн</option>
          <option value="8">рзо</option><option value="9">рзп</option><option value="10">рззрзж</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">рж░рзЛрж▓</label>
        <input class="form-control" id="sRoll" type="number" placeholder="рж░рзЛрж▓ ржиржорзНржмрж░">
      </div>
      <div class="form-group">
        <label class="form-label">ржорзЛржмрж╛ржЗрж▓</label>
        <input class="form-control" id="sPhone" placeholder="01XXXXXXXXX">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">ржмрзНржпрж╛ржЪ</label>
      <select class="form-control" id="sBatch">
        <option value="A">Batch A</option>
        <option value="B">Batch B</option>
        <option value="C">Batch C</option>
        <option value="D">Batch D</option>
        <option value="E">Batch E</option>
      </select>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('addStudentModal')">ржмрж╛рждрж┐рж▓</button>
      <button class="btn btn-success" onclick="addStudent()">тЬУ ржпрзЛржЧ ржХрж░рзБржи</button>
    </div>
  </div>
</div>

<!-- Add Exam -->
<div class="modal-overlay" id="addExamModal">
  <div class="modal">
    <h3>ЁЯУЛ ржирждрзБржи ржкрж░рзАржХрзНрж╖рж╛ рждрзИрж░рж┐ ржХрж░рзБржи</h3>
    <div class="alert alert-error" id="addExamError"></div>
    <div class="form-row">
      <div class="form-group" style="grid-column:1/-1">
        <label class="form-label">ржкрж░рзАржХрзНрж╖рж╛рж░ рж╢рж┐рж░рзЛржирж╛ржо</label>
        <input class="form-control" id="eTitle" placeholder="ржпрзЗржоржи: рж╕ржкрзНрждрж╛рж╣ рзз - ржЧржгрж┐ржд ржкрж░рзАржХрзНрж╖рж╛">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">ржмрж┐рж╖ржпрж╝</label>
        <input class="form-control" id="eSubject" placeholder="ржЧржгрж┐ржд, ржмрж┐ржЬрзНржЮрж╛ржи...">
      </div>
      <div class="form-group">
        <label class="form-label">ржХрзНрж▓рж╛рж╕</label>
        <select class="form-control" id="eClass">
          <option value="6">рзм</option><option value="7">рзн</option>
          <option value="8">рзо</option><option value="9">рзп</option><option value="10">рззрзж</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">рж╕ржкрзНрждрж╛рж╣ ржиржорзНржмрж░</label>
        <input class="form-control" id="eWeek" type="number" value="1" min="1">
      </div>
      <div class="form-group">
        <label class="form-label">ржорж╛рж╕</label>
        <input class="form-control" id="eMonth" placeholder="February 2025">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">рж╕ржоржпрж╝ (ржорж┐ржирж┐ржЯ)</label>
        <input class="form-control" id="eDuration" type="number" value="30" min="5">
      </div>
      <div class="form-group">
        <label class="form-label">ржмрзНржпрж╛ржЪ</label>
        <select class="form-control" id="eBatch">
          <option value="A">Batch A</option>
          <option value="B">Batch B</option>
          <option value="C">Batch C</option>
          <option value="D">Batch D</option>
          <option value="E">Batch E</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">рж╢рзБрж░рзБрж░ рждрж╛рж░рж┐ржЦ</label>
        <input class="form-control" id="eStart" type="datetime-local">
      </div>
      <div class="form-group">
        <label class="form-label">рж╢рзЗрж╖ рждрж╛рж░рж┐ржЦ</label>
        <input class="form-control" id="eEnd" type="datetime-local">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('addExamModal')">ржмрж╛рждрж┐рж▓</button>
      <button class="btn btn-success" onclick="addExam()">тЬУ рждрзИрж░рж┐ ржХрж░рзБржи</button>
    </div>
  </div>
</div>

<!-- Add Question -->
<div class="modal-overlay" id="addQuestionModal">
  <div class="modal">
    <h3>тЭУ ржирждрзБржи ржкрзНрж░рж╢рзНржи ржпрзЛржЧ ржХрж░рзБржи</h3>
    <div class="alert alert-error" id="addQError"></div>
    <div class="form-group">
      <label class="form-label">ржкрзНрж░рж╢рзНржирзЗрж░ ржзрж░ржи</label>
      <select class="form-control" id="qType" onchange="toggleQuestionType()">
        <option value="mcq">MCQ (рзкржЯрж┐ ржЕржкрж╢ржи)</option>
        <option value="truefalse">рж╕рждрзНржп / ржорж┐ржерзНржпрж╛</option>
        <option value="fillinblank">рж╢рзВржирзНржпрж╕рзНржерж╛ржи ржкрзВрж░ржг (Dropdown)</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">ржкрзНрж░рж╢рзНржи <span style="color:var(--text-muted);font-weight:400">(KaTeX: \frac{1}{2}, \sqrt{4}, рж╢рзВржирзНржпрж╕рзНржерж╛ржирзЗ ___ рж▓рж┐ржЦрзБржи)</span></label>
      <textarea class="form-control" id="qText" placeholder="ржкрзНрж░рж╢рзНржи рж▓рж┐ржЦрзБржи..."></textarea>
    </div>

    <!-- MCQ Options -->
    <div id="mcqOptions">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ржЕржкрж╢ржи A</label>
          <input class="form-control" id="qA" placeholder="ржЕржкрж╢ржи A">
        </div>
        <div class="form-group">
          <label class="form-label">ржЕржкрж╢ржи B</label>
          <input class="form-control" id="qB" placeholder="ржЕржкрж╢ржи B">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ржЕржкрж╢ржи C</label>
          <input class="form-control" id="qC" placeholder="ржЕржкрж╢ржи C">
        </div>
        <div class="form-group">
          <label class="form-label">ржЕржкрж╢ржи D</label>
          <input class="form-control" id="qD" placeholder="ржЕржкрж╢ржи D">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">рж╕ржарж┐ржХ ржЙрждрзНрждрж░</label>
          <select class="form-control" id="qCorrect">
            <option value="a">A</option><option value="b">B</option>
            <option value="c">C</option><option value="d">D</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ржкрзНрж░рж╢рзНржирзЗрж░ ржХрзНрж░ржо</label>
          <input class="form-control" id="qOrder" type="number" value="1" min="1">
        </div>
      </div>
    </div>

    <!-- True/False Options -->
    <div id="tfOptions" style="display:none">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">"рж╕рждрзНржп" ржмрж╛ржЯржирзЗрж░ рж▓рзЗржЦрж╛</label>
          <input class="form-control" id="qTFTrue" value="рж╕рждрзНржп" placeholder="рж╕рждрзНржп">
        </div>
        <div class="form-group">
          <label class="form-label">"ржорж┐ржерзНржпрж╛" ржмрж╛ржЯржирзЗрж░ рж▓рзЗржЦрж╛</label>
          <input class="form-control" id="qTFFalse" value="ржорж┐ржерзНржпрж╛" placeholder="ржорж┐ржерзНржпрж╛">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">рж╕ржарж┐ржХ ржЙрждрзНрждрж░</label>
          <select class="form-control" id="qTFCorrect">
            <option value="рж╕рждрзНржп">рж╕рждрзНржп</option>
            <option value="ржорж┐ржерзНржпрж╛">ржорж┐ржерзНржпрж╛</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ржкрзНрж░рж╢рзНржирзЗрж░ ржХрзНрж░ржо</label>
          <input class="form-control" id="qTFOrder" type="number" value="1" min="1">
        </div>
      </div>
    </div>

    <!-- Fill in Blank Options -->
    <div id="fibOptions" style="display:none">
      <p style="font-size:0.82rem;color:var(--text-muted);margin-bottom:0.8rem">
        рзи-рзкржЯрж┐ ржЕржкрж╢ржи ржжрж┐ржиред ржпрзЗржЯрж╛ рж╕ржарж┐ржХ рж╕рзЗржЯрж╛ ржирж┐рж░рзНржмрж╛ржЪржи ржХрж░рзБржиред
      </p>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ржЕржкрж╢ржи A</label>
          <input class="form-control" id="qFIBA" placeholder="ржЕржкрж╢ржи A">
        </div>
        <div class="form-group">
          <label class="form-label">ржЕржкрж╢ржи B</label>
          <input class="form-control" id="qFIBB" placeholder="ржЕржкрж╢ржи B">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ржЕржкрж╢ржи C <span style="color:var(--text-muted)">(ржРржЪрзНржЫрж┐ржХ)</span></label>
          <input class="form-control" id="qFIBC" placeholder="ржЕржкрж╢ржи C (ржирж╛ ржжрж┐рж▓рзЗ ржЦрж╛рж▓рж┐ рж░рж╛ржЦрзБржи)">
        </div>
        <div class="form-group">
          <label class="form-label">ржЕржкрж╢ржи D <span style="color:var(--text-muted)">(ржРржЪрзНржЫрж┐ржХ)</span></label>
          <input class="form-control" id="qFIBD" placeholder="ржЕржкрж╢ржи D (ржирж╛ ржжрж┐рж▓рзЗ ржЦрж╛рж▓рж┐ рж░рж╛ржЦрзБржи)">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">рж╕ржарж┐ржХ ржЙрждрзНрждрж░</label>
          <select class="form-control" id="qFIBCorrect">
            <option value="a">A</option><option value="b">B</option>
            <option value="c">C</option><option value="d">D</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ржкрзНрж░рж╢рзНржирзЗрж░ ржХрзНрж░ржо</label>
          <input class="form-control" id="qFIBOrder" type="number" value="1" min="1">
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('addQuestionModal')">ржмрж╛рждрж┐рж▓</button>
      <button class="btn btn-success" onclick="addQuestion()">тЬУ ржпрзЛржЧ ржХрж░рзБржи</button>
    </div>
  </div>
</div>

<!-- Bulk Import Modal -->
<div class="modal-overlay" id="bulkImportModal">
  <div class="modal" style="max-width:620px">
    <h3>ЁЯУе CSV ржжрж┐ржпрж╝рзЗ ржмрж╛рж▓рзНржХ ржнрж░рзНрждрж┐</h3>
    <div style="background:rgba(79,70,229,0.1);border:1px solid var(--border);border-radius:10px;padding:1rem;margin-bottom:1rem;font-size:0.85rem;color:var(--text-muted)">
      <strong style="color:var(--primary-light)">CSV ржлрж░ржорзНржпрж╛ржЯ:</strong><br>
      ржкрзНрж░ржержо рж▓рж╛ржЗржи header (skip рж╣ржмрзЗ)<br>
      <code style="color:#34D399">ржирж╛ржо,ржХрзНрж▓рж╛рж╕,рж░рзЛрж▓,ржорзЛржмрж╛ржЗрж▓,ржмрзНржпрж╛ржЪ</code><br><br>
      ржЙржжрж╛рж╣рж░ржг:<br>
      <code style="color:#FCD34D">
        рж░рж╛рж╣рзЗрж▓рж╛ ржмрзЗржЧржо,6,1,01711000001,A<br>
        ржХрж░рж┐ржо рж╣рзЛрж╕рзЗржи,7,2,01711000002,B
      </code>
    </div>

    <div style="margin-bottom:1rem">
      <label class="form-label">CSV ржлрж╛ржЗрж▓ ржмрзЗржЫрзЗ ржирж┐ржи</label>
      <input type="file" id="csvFile" accept=".csv" class="form-control" onchange="previewCSV()">
    </div>

    <div id="csvPreview" style="display:none;margin-bottom:1rem">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem">
        <span style="font-size:0.85rem;font-weight:600;color:var(--primary-light)" id="csvPreviewLabel">ржкрзНрж░рж┐ржнрж┐ржЙ</span>
        <span class="badge badge-active" id="csvCount"></span>
      </div>
      <div style="max-height:200px;overflow-y:auto;border:1px solid var(--border);border-radius:10px">
        <table style="font-size:0.8rem">
          <thead><tr><th>ржирж╛ржо</th><th>ржХрзНрж▓рж╛рж╕</th><th>рж░рзЛрж▓</th><th>ржорзЛржмрж╛ржЗрж▓</th><th>ржмрзНржпрж╛ржЪ</th><th>ржЕржмрж╕рзНржерж╛</th></tr></thead>
          <tbody id="csvPreviewBody"></tbody>
        </table>
      </div>
    </div>

    <div class="alert alert-error" id="bulkError"></div>
    <div class="alert alert-success" id="bulkSuccess"></div>

    <div style="background:rgba(255,255,255,0.04);border-radius:10px;padding:0.8rem;margin-bottom:1rem;font-size:0.82rem;color:var(--text-muted)">
      тЪая╕П ржПржХржЗ class+roll ржмрж╛ phone number ржерж╛ржХрж▓рзЗ рж╕рзЗржЗ row skip рж╣ржмрзЗ, ржмрж╛ржХрж┐ржЧрзБрж▓рзЛ import рж╣ржмрзЗред
    </div>

    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('bulkImportModal');resetCSV()">ржмрж╛рждрж┐рж▓</button>
      <a id="csvTemplateLink" style="display:none"></a>
      <button class="btn btn-ghost" onclick="downloadTemplate()">ЁЯУД Template Download</button>
      <button class="btn btn-success" id="importBtn" onclick="importStudents()" disabled>ЁЯУе Import ржХрж░рзБржи</button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://cjeaahqwcejxqfiascpz.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNqZWFhaHF3Y2VqeHFmaWFzY3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMjA1NjcsImV4cCI6MjA4NzY5NjU2N30.tNRinQBmUfnwTV_Qh6G6gwaKThXG1AZW2v-t2qWqEK8';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let selectedExamForQ = null;
let parsedCSVData = [];

function loading(s) { document.getElementById('loadingOverlay').style.display = s?'flex':'none'; }
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
function showAlert(id, msg, type='error') {
  const el = document.getElementById(id);
  if(!el) return;
  el.textContent = msg; el.style.display='block'; el.className=`alert alert-${type}`;
  setTimeout(()=>{ el.style.display='none'; }, 4000);
}

// тФАтФА CSV IMPORT тФАтФА
function previewCSV() {
  const file = document.getElementById('csvFile').files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const lines = e.target.result.split('\n').filter(l=>l.trim());
    parsedCSVData = [];
    const tbody = document.getElementById('csvPreviewBody');
    tbody.innerHTML = '';
    // Skip header row
    for(let i=1; i<lines.length; i++) {
      const cols = lines[i].split(',').map(c=>c.trim().replace(/"/g,''));
      if(cols.length < 4) continue;
      const [name, cls, roll, phone, batch='A'] = cols;
      if(!name||!cls||!roll||!phone) continue;
      const valid = name.length>0 && ['6','7','8','9','10'].includes(cls) && roll.length>0 && phone.length>=11;
      parsedCSVData.push({name,class:cls,roll,phone,batch:batch||'A',valid});
      tbody.innerHTML += `<tr>
        <td>${name}</td><td>${cls}</td><td>${roll}</td>
        <td>${phone}</td><td>${batch||'A'}</td>
        <td>${valid?'<span class="badge badge-active">тЬУ</span>':'<span class="badge badge-inactive">тЬЧ</span>'}</td>
      </tr>`;
    }
    const validCount = parsedCSVData.filter(r=>r.valid).length;
    document.getElementById('csvPreview').style.display = 'block';
    document.getElementById('csvCount').textContent = `${validCount} ржЬржи valid`;
    document.getElementById('importBtn').disabled = validCount === 0;
  };
  reader.readAsText(file, 'UTF-8');
}

async function importStudents() {
  const validRows = parsedCSVData.filter(r=>r.valid);
  if(!validRows.length) return;
  loading(true);
  let success=0, skipped=0;
  for(const row of validRows) {
    const {error} = await sb.from('students').insert({
      name:row.name, class:row.class, roll:row.roll,
      phone:row.phone, batch:row.batch
    });
    if(error) skipped++;
    else success++;
  }
  loading(false);
  showAlert('bulkSuccess', `тЬЕ ${success} ржЬржи import рж╣ржпрж╝рзЗржЫрзЗред ${skipped} ржЬржи skip рж╣ржпрж╝рзЗржЫрзЗ (duplicate)ред`, 'success');
  setTimeout(()=>{ closeModal('bulkImportModal'); resetCSV(); loadStudents(); }, 2500);
}

function resetCSV() {
  parsedCSVData = [];
  document.getElementById('csvFile').value = '';
  document.getElementById('csvPreview').style.display = 'none';
  document.getElementById('importBtn').disabled = true;
}

function downloadTemplate() {
  const csv = `ржирж╛ржо,ржХрзНрж▓рж╛рж╕,рж░рзЛрж▓,ржорзЛржмрж╛ржЗрж▓,ржмрзНржпрж╛ржЪ\nрж░рж╛рж╣рзЗрж▓рж╛ ржмрзЗржЧржо,6,1,01711000001,A\nржХрж░рж┐ржо рж╣рзЛрж╕рзЗржи,7,2,01711000002,B\nрж╕рзБржорж╛ржЗржпрж╝рж╛ ржЖржХрзНрждрж╛рж░,8,3,01711000003,A`;
  const blob = new Blob(['\uFEFF'+csv], {type:'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download='students_template.csv'; a.click();
  URL.revokeObjectURL(url);
}

// тФАтФА ADMIN LOGIN тФАтФА
async function adminLogin() {
  const user = document.getElementById('adminUser').value.trim();
  const pass = document.getElementById('adminPass').value.trim();
  if(!user||!pass){showAlert('adminLoginError','рж╕ржм рждржерзНржп ржкрзВрж░ржг ржХрж░рзБржи');return;}
  loading(true);
  const {data} = await sb.from('admins').select('*').eq('username',user).eq('password_hash',pass).single();
  loading(false);
  if(!data){showAlert('adminLoginError','ржнрзБрж▓ username ржЕржержмрж╛ password');return;}
  sessionStorage.setItem('adminLoggedIn','true');
  document.getElementById('adminLoginWrap').style.display='none';
  document.getElementById('adminApp').style.display='block';
  loadDashboard();
}
function adminLogout(){
  sessionStorage.removeItem('adminLoggedIn');
  location.reload();
}

// тФАтФА SIDEBAR TOGGLE (Mobile) тФАтФА
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('active');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('active');
}

// тФАтФА NAVIGATION тФАтФА
function showSection(name, el) {
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('sec-'+name).classList.add('active');
  el.classList.add('active');
  closeSidebar(); // ржорзЛржмрж╛ржЗрж▓рзЗ sidebar ржмржирзНржз ржХрж░рзЛ
  const loaders = {students:loadStudents,exams:loadExams,questions:loadQExamList,results:loadResultFilters,merit:loadAdminMerit};
  if(loaders[name]) loaders[name]();
}

// тФАтФА DASHBOARD тФАтФА
async function loadDashboard() {
  const [s,e,q,r] = await Promise.all([
    sb.from('students').select('id',{count:'exact',head:true}),
    sb.from('exams').select('id',{count:'exact',head:true}),
    sb.from('questions').select('id',{count:'exact',head:true}),
    sb.from('results').select('id',{count:'exact',head:true})
  ]);
  document.getElementById('totalStudents').textContent = s.count||0;
  document.getElementById('totalExams').textContent = e.count||0;
  document.getElementById('totalQuestions').textContent = q.count||0;
  document.getElementById('totalResults').textContent = r.count||0;

  const {data:recent} = await sb.from('results')
    .select('*, students(name,class,roll,batch), exams(title,batch)')
    .order('submitted_at',{ascending:false}).limit(10);
  const wrap = document.getElementById('recentResultsTable');
  if(!recent||!recent.length){wrap.innerHTML='<p style="color:var(--text-muted);padding:1rem">ржХрзЛржирзЛ ржлрж▓рж╛ржлрж▓ ржирзЗржЗ</p>';return;}
  wrap.innerHTML = `<table><thead><tr><th>рж╢рж┐ржХрзНрж╖рж╛рж░рзНржерзА</th><th>ржХрзНрж▓рж╛рж╕</th><th>ржмрзНржпрж╛ржЪ</th><th>рж░рзЛрж▓</th><th>ржкрж░рзАржХрзНрж╖рж╛</th><th>ржиржорзНржмрж░</th><th>рж╢рждрж╛ржВрж╢</th><th>рждрж╛рж░рж┐ржЦ</th></tr></thead>
  <tbody>${recent.map(r=>`<tr>
    <td>${r.students?.name||'-'}</td>
    <td><span class="badge badge-class">${r.students?.class||'-'}</span></td>
    <td><span class="badge" style="background:rgba(245,158,11,0.15);color:#FCD34D">Batch ${r.students?.batch||'-'}</span></td>
    <td>${r.students?.roll||'-'}</td>
    <td>${r.exams?.title||'-'}</td>
    <td><strong>${r.score}/${r.total_questions}</strong></td>
    <td>${Math.round(r.score/r.total_questions*100)}%</td>
    <td>${new Date(r.submitted_at).toLocaleDateString('bn-BD')}</td>
  </tr>`).join('')}</tbody></table>`;
}

// тФАтФА STUDENTS тФАтФА
async function loadStudents() {
  const cls = document.getElementById('filterClass').value;
  const batch = document.getElementById('filterBatch').value;
  let q = sb.from('students').select('*').order('class').order('batch').order('roll');
  if(cls) q = q.eq('class',cls);
  if(batch) q = q.eq('batch',batch);
  const {data} = await q;
  const wrap = document.getElementById('studentsTable');
  if(!data||!data.length){wrap.innerHTML='<p style="padding:1rem;color:var(--text-muted)">ржХрзЛржирзЛ рж╢рж┐ржХрзНрж╖рж╛рж░рзНржерзА ржирзЗржЗ</p>';return;}
  wrap.innerHTML = `<table><thead><tr><th>ржирж╛ржо</th><th>ржХрзНрж▓рж╛рж╕</th><th>ржмрзНржпрж╛ржЪ</th><th>рж░рзЛрж▓</th><th>ржорзЛржмрж╛ржЗрж▓</th><th>ржпрзЛржЧржжрж╛ржи</th><th>ржорзБржЫрзБржи</th></tr></thead>
  <tbody>${data.map(s=>`<tr>
    <td><strong>${s.name}</strong></td>
    <td><span class="badge badge-class">ржХрзНрж▓рж╛рж╕ ${s.class}</span></td>
    <td><span class="badge" style="background:rgba(245,158,11,0.15);color:#FCD34D">Batch ${s.batch}</span></td>
    <td>${s.roll}</td>
    <td>${s.phone}</td>
    <td>${new Date(s.created_at).toLocaleDateString('bn-BD')}</td>
    <td><button class="btn btn-danger btn-sm" onclick="deleteStudent('${s.id}','${s.name}')">ЁЯЧС</button></td>
  </tr>`).join('')}</tbody></table>`;
}

async function addStudent() {
  const name=document.getElementById('sName').value.trim();
  const cls=document.getElementById('sClass').value;
  const roll=document.getElementById('sRoll').value.trim();
  const phone=document.getElementById('sPhone').value.trim();
  const batch=document.getElementById('sBatch').value;
  if(!name||!roll||!phone){showAlert('addStudentError','рж╕ржм рждржерзНржп ржкрзВрж░ржг ржХрж░рзБржи');return;}
  loading(true);
  const {error} = await sb.from('students').insert({name,class:cls,roll,phone,batch});
  loading(false);
  if(error){showAlert('addStudentError','рждрзНрж░рзБржЯрж┐: '+error.message);return;}
  showAlert('addStudentSuccess','рж╢рж┐ржХрзНрж╖рж╛рж░рзНржерзА ржпрзЛржЧ рж╣ржпрж╝рзЗржЫрзЗ!','success');
  document.getElementById('sName').value='';document.getElementById('sRoll').value='';document.getElementById('sPhone').value='';
  setTimeout(()=>closeModal('addStudentModal'),1500);
  loadStudents();
}

async function deleteStudent(id,name) {
  if(!confirm(`"${name}" ржХрзЗ ржорзБржЫрзЗ ржлрзЗрж▓ржмрзЗржи?`)) return;
  loading(true);
  await sb.from('students').delete().eq('id',id);
  loading(false);
  loadStudents();
}

// тФАтФА EXAMS тФАтФА
async function loadExams() {
  const {data} = await sb.from('exams').select('*').order('created_at',{ascending:false});
  const wrap = document.getElementById('examsTable');
  if(!data||!data.length){wrap.innerHTML='<p style="padding:1rem;color:var(--text-muted)">ржХрзЛржирзЛ ржкрж░рзАржХрзНрж╖рж╛ ржирзЗржЗ</p>';return;}
  wrap.innerHTML = `<table><thead><tr><th>рж╢рж┐рж░рзЛржирж╛ржо</th><th>ржмрж┐рж╖ржпрж╝</th><th>ржХрзНрж▓рж╛рж╕</th><th>ржмрзНржпрж╛ржЪ</th><th>рж╕ржкрзНрждрж╛рж╣</th><th>рж╕ржоржпрж╝</th><th>рж╢рзЗрж╖ рждрж╛рж░рж┐ржЦ</th><th>ржЕржмрж╕рзНржерж╛</th><th>ржХрж╛ржЬ</th></tr></thead>
  <tbody>${data.map(e=>{
    const expired = new Date(e.end_date)<new Date();
    return `<tr>
      <td><strong>${e.title}</strong></td>
      <td>${e.subject}</td>
      <td><span class="badge badge-class">${e.class}</span></td>
      <td><span class="badge" style="background:rgba(245,158,11,0.15);color:#FCD34D">Batch ${e.batch||'A'}</span></td>
      <td>рж╕ржкрзНрждрж╛рж╣ ${e.week_number}</td>
      <td>${e.duration_minutes} ржорж┐ржирж┐ржЯ</td>
      <td>${new Date(e.end_date).toLocaleDateString('bn-BD')}</td>
      <td><span class="badge ${expired?'badge-inactive':'badge-active'}">${expired?'ржорзЗржпрж╝рж╛ржж рж╢рзЗрж╖':'рж╕ржХрзНрж░рж┐ржпрж╝'}</span></td>
      <td><button class="btn btn-danger btn-sm" onclick="deleteExam('${e.id}')">ЁЯЧС</button></td>
    </tr>`;
  }).join('')}</tbody></table>`;
}

async function addExam() {
  const title=document.getElementById('eTitle').value.trim();
  const subject=document.getElementById('eSubject').value.trim();
  const cls=document.getElementById('eClass').value;
  const week=parseInt(document.getElementById('eWeek').value);
  const month=document.getElementById('eMonth').value.trim();
  const dur=parseInt(document.getElementById('eDuration').value);
  const batch=document.getElementById('eBatch').value;
  const start=document.getElementById('eStart').value;
  const end=document.getElementById('eEnd').value;
  if(!title||!subject||!month||!start||!end){showAlert('addExamError','рж╕ржм рждржерзНржп ржкрзВрж░ржг ржХрж░рзБржи');return;}
  loading(true);
  const {error} = await sb.from('exams').insert({title,subject,class:cls,week_number:week,month,duration_minutes:dur,batch,start_date:new Date(start).toISOString(),end_date:new Date(end).toISOString()});
  loading(false);
  if(error){showAlert('addExamError','рждрзНрж░рзБржЯрж┐: '+error.message);return;}
  closeModal('addExamModal');
  loadExams();
}

async function deleteExam(id) {
  if(!confirm('ржПржЗ ржкрж░рзАржХрзНрж╖рж╛ ржорзБржЫрзЗ ржлрзЗрж▓ржмрзЗржи? рж╕ржм ржкрзНрж░рж╢рзНржиржУ ржорзБржЫрзЗ ржпрж╛ржмрзЗред')) return;
  loading(true);
  await sb.from('exams').delete().eq('id',id);
  loading(false);
  loadExams();
}

// тФАтФА QUESTIONS тФАтФА
async function loadQExamList() {
  const {data} = await sb.from('exams').select('id,title,class,batch').order('created_at',{ascending:false});
  const sel = document.getElementById('qExamFilter');
  sel.innerHTML = '<option value="">ржкрж░рзАржХрзНрж╖рж╛ ржмрзЗржЫрзЗ ржирж┐ржи</option>';
  (data||[]).forEach(e=>{ sel.innerHTML += `<option value="${e.id}">${e.title} (ржХрзНрж▓рж╛рж╕ ${e.class}, Batch ${e.batch||'A'})</option>`; });
}

async function loadQuestions() {
  const examId = document.getElementById('qExamFilter').value;
  document.getElementById('addQBtn').style.display = examId?'inline-flex':'none';
  selectedExamForQ = examId;
  if(!examId){document.getElementById('questionsList').innerHTML='<p style="color:var(--text-muted)">ржкрж░рзАржХрзНрж╖рж╛ ржмрзЗржЫрзЗ ржирж┐ржи</p>';return;}
  const {data} = await sb.from('questions').select('*').eq('exam_id',examId).order('question_order');
  const wrap = document.getElementById('questionsList');
  if(!data||!data.length){wrap.innerHTML='<div class="card"><p style="color:var(--text-muted)">ржХрзЛржирзЛ ржкрзНрж░рж╢рзНржи ржирзЗржЗред ржкрзНрж░рж╢рзНржи ржпрзЛржЧ ржХрж░рзБржиред</p></div>';return;}
  wrap.innerHTML = data.map((q,i)=>{
    const typeBadge = {
      mcq: '<span style="background:rgba(124,58,237,0.2);color:#A78BFA;padding:0.1rem 0.5rem;border-radius:20px;font-size:0.7rem;font-weight:700">MCQ</span>',
      truefalse: '<span style="background:rgba(16,185,129,0.2);color:#34D399;padding:0.1rem 0.5rem;border-radius:20px;font-size:0.7rem;font-weight:700">рж╕рждрзНржп/ржорж┐ржерзНржпрж╛</span>',
      fitb: '<span style="background:rgba(245,158,11,0.2);color:#FCD34D;padding:0.1rem 0.5rem;border-radius:20px;font-size:0.7rem;font-weight:700">рж╢рзВржирзНржпрж╕рзНржерж╛ржи</span>',
      fillinblank: '<span style="background:rgba(245,158,11,0.2);color:#FCD34D;padding:0.1rem 0.5rem;border-radius:20px;font-size:0.7rem;font-weight:700">рж╢рзВржирзНржпрж╕рзНржерж╛ржи</span>'
    };
    const type = q.question_type || 'mcq';
    let optionsHtml = '';
    if (type === 'truefalse') {
      const ca = q.correct_answer;
      optionsHtml = `<span class="${ca===q.option_a||ca==='рж╕рждрзНржп'?'q-correct':''}">тЬЕ ${q.option_a||'рж╕рждрзНржп'}</span>
         <span class="${ca===q.option_b||ca==='ржорж┐ржерзНржпрж╛'?'q-correct':''}">тЭМ ${q.option_b||'ржорж┐ржерзНржпрж╛'}</span>`;
    } else if (type === 'fitb') {
      const ca = q.correct_answer;
      optionsHtml = [q.option_a,q.option_b,q.option_c,q.option_d].filter(Boolean).map((o,idx)=>
        `<span class="${ca===o?'q-correct':''}">${'ABCD'[idx]}: ${o}</span>`).join('');
    } else {
      optionsHtml = `<span class="${q.correct_answer==='a'?'q-correct':''}">A: ${q.option_a||''}</span>
         <span class="${q.correct_answer==='b'?'q-correct':''}">B: ${q.option_b||''}</span>
         ${q.option_c?`<span class="${q.correct_answer==='c'?'q-correct':''}">C: ${q.option_c}</span>`:''}
         ${q.option_d?`<span class="${q.correct_answer==='d'?'q-correct':''}">D: ${q.option_d}</span>`:''}`;
    }
    return `
    <div class="q-item">
      <div class="q-item-header">
        <span style="display:flex;align-items:center;gap:0.5rem">
          <span style="font-size:0.78rem;color:var(--primary-light);font-weight:600">ржкрзНрж░рж╢рзНржи ${i+1}</span>
          ${typeBadge[type]||typeBadge.mcq}
        </span>
        <button class="btn btn-danger btn-sm" onclick="deleteQuestion('${q.id}')">ЁЯЧС ржорзБржЫрзБржи</button>
      </div>
      <div class="q-item-text">${q.question_text}</div>
      <div class="q-item-options">${optionsHtml}</div>
    </div>`;
  }).join('');
}

function toggleQuestionType() {
  const type = document.getElementById('qType').value;
  document.getElementById('mcqOptions').style.display = type === 'mcq' ? 'block' : 'none';
  document.getElementById('tfOptions').style.display = type === 'truefalse' ? 'block' : 'none';
  document.getElementById('fibOptions').style.display = type === 'fillinblank' ? 'block' : 'none';
}

function openAddQuestion() {
  if(!selectedExamForQ){alert('ржЖржЧрзЗ ржкрж░рзАржХрзНрж╖рж╛ ржмрзЗржЫрзЗ ржирж┐ржи');return;}
  document.getElementById('qType').value = 'mcq';
  toggleQuestionType();
  openModal('addQuestionModal');
}

async function addQuestion() {
  const type = document.getElementById('qType').value;
  const text = document.getElementById('qText').value.trim();
  if(!text) { showAlert('addQError','ржкрзНрж░рж╢рзНржи рж▓рж┐ржЦрзБржи'); return; }

  // admin ржП fillinblank ржХрж┐ржирзНрждрзБ DB рждрзЗ fitb
  const dbType = type === 'fillinblank' ? 'fitb' : type;
  let payload = { exam_id: selectedExamForQ, question_text: text, question_type: dbType };

  if (type === 'mcq') {
    const a=document.getElementById('qA').value.trim();
    const b=document.getElementById('qB').value.trim();
    const c=document.getElementById('qC').value.trim();
    const d=document.getElementById('qD').value.trim();
    if(!a||!b||!c||!d){ showAlert('addQError','рж╕ржм ржЕржкрж╢ржи ржкрзВрж░ржг ржХрж░рзБржи'); return; }
    payload = {...payload, option_a:a, option_b:b, option_c:c, option_d:d,
      correct_answer: document.getElementById('qCorrect').value,
      question_order: parseInt(document.getElementById('qOrder').value)||1 };

  } else if (type === 'truefalse') {
    const trueLabel = document.getElementById('qTFTrue').value || 'рж╕рждрзНржп';
    const falseLabel = document.getElementById('qTFFalse').value || 'ржорж┐ржерзНржпрж╛';
    const correctVal = document.getElementById('qTFCorrect').value; // 'рж╕рждрзНржп' ржмрж╛ 'ржорж┐ржерзНржпрж╛'
    payload = {...payload,
      option_a: trueLabel,
      option_b: falseLabel,
      correct_answer: correctVal,
      question_order: parseInt(document.getElementById('qTFOrder').value)||1 };

  } else if (type === 'fillinblank') {
    const a=document.getElementById('qFIBA').value.trim();
    const b=document.getElementById('qFIBB').value.trim();
    if(!a||!b){ showAlert('addQError','ржХржоржкржХрзНрж╖рзЗ рзиржЯрж┐ ржЕржкрж╢ржи ржжрж┐ржи'); return; }
    const correctText = document.getElementById('qFIBCorrect').value.trim();
    if(!correctText){ showAlert('addQError','рж╕ржарж┐ржХ ржЙрждрзНрждрж░ рж▓рж┐ржЦрзБржи'); return; }
    payload = {...payload,
      option_a: a, option_b: b,
      option_c: document.getElementById('qFIBC').value.trim()||null,
      option_d: document.getElementById('qFIBD').value.trim()||null,
      correct_answer: correctText,
      question_order: parseInt(document.getElementById('qFIBOrder').value)||1 };
  }

  loading(true);
  const {error} = await sb.from('questions').insert(payload);
  loading(false);
  if(error){ showAlert('addQError','рждрзНрж░рзБржЯрж┐: '+error.message); return; }

  ['qText','qA','qB','qC','qD','qFIBA','qFIBB','qFIBC','qFIBD','qFIBCorrect'].forEach(id => {
    const el = document.getElementById(id); if(el) el.value='';
  });
  closeModal('addQuestionModal');
  loadQuestions();
}

async function deleteQuestion(id) {
  if(!confirm('ржПржЗ ржкрзНрж░рж╢рзНржи ржорзБржЫрзЗ ржлрзЗрж▓ржмрзЗржи?')) return;
  await sb.from('questions').delete().eq('id',id);
  loadQuestions();
}

// тФАтФА RESULTS тФАтФА
async function loadResultFilters() {
  const {data} = await sb.from('exams').select('id,title,class,batch').order('created_at',{ascending:false});
  const sel = document.getElementById('resultExamFilter');
  sel.innerHTML = '<option value="">рж╕ржм ржкрж░рзАржХрзНрж╖рж╛</option>';
  (data||[]).forEach(e=>{ sel.innerHTML += `<option value="${e.id}">${e.title} (ржХрзНрж▓рж╛рж╕ ${e.class}, Batch ${e.batch||'A'})</option>`; });
  loadResults();
}

async function loadResults() {
  const examId = document.getElementById('resultExamFilter').value;
  const cls = document.getElementById('resultClassFilter').value;
  let q = sb.from('results').select('*, students(name,class,roll,batch), exams(title,batch)').order('submitted_at',{ascending:false}).limit(100);
  if(examId) q = q.eq('exam_id',examId);
  const {data} = await q;
  let rows = data||[];
  if(cls) rows = rows.filter(r=>r.students?.class===cls);
  const sorted = rows.sort((a,b)=>b.score-a.score);
  const wrap = document.getElementById('resultsTable');
  if(!rows.length){wrap.innerHTML='<p style="padding:1rem;color:var(--text-muted)">ржХрзЛржирзЛ ржлрж▓рж╛ржлрж▓ ржирзЗржЗ</p>';return;}
  wrap.innerHTML = `<table><thead><tr><th>#</th><th>ржирж╛ржо</th><th>ржХрзНрж▓рж╛рж╕</th><th>ржмрзНржпрж╛ржЪ</th><th>рж░рзЛрж▓</th><th>ржкрж░рзАржХрзНрж╖рж╛</th><th>ржиржорзНржмрж░</th><th>рж╢рждрж╛ржВрж╢</th><th>рждрж╛рж░рж┐ржЦ</th></tr></thead>
  <tbody>${sorted.map((r,i)=>`<tr>
    <td>${i+1}</td>
    <td>${r.students?.name||'-'}</td>
    <td><span class="badge badge-class">${r.students?.class||'-'}</span></td>
    <td><span class="badge" style="background:rgba(245,158,11,0.15);color:#FCD34D">Batch ${r.students?.batch||'-'}</span></td>
    <td>${r.students?.roll||'-'}</td>
    <td style="font-size:0.8rem">${r.exams?.title||'-'}</td>
    <td><strong>${r.score}/${r.total_questions}</strong></td>
    <td>${Math.round(r.score/r.total_questions*100)}%</td>
    <td>${new Date(r.submitted_at).toLocaleDateString('bn-BD')}</td>
  </tr>`).join('')}</tbody></table>`;
}

// тФАтФА MERIT тФАтФА
async function loadAdminMerit() {
  const cls = document.getElementById('meritClassFilter').value;
  const batch = document.getElementById('meritBatchFilter').value;
  const month = document.getElementById('meritMonthFilter').value;
  const {data} = await sb.from('monthly_merit').select('*').eq('class',cls).eq('batch',batch).eq('month',month).order('merit_position');
  const wrap = document.getElementById('meritTable');
  if(!data||!data.length){wrap.innerHTML='<p style="padding:1rem;color:var(--text-muted)">ржХрзЛржирзЛ рждржерзНржп ржирзЗржЗ</p>';return;}
  wrap.innerHTML = `<table><thead><tr><th>рж╕рзНржерж╛ржи</th><th>ржирж╛ржо</th><th>ржмрзНржпрж╛ржЪ</th><th>рж░рзЛрж▓</th><th>ржорзЛржмрж╛ржЗрж▓</th><th>ржкрж░рзАржХрзНрж╖рж╛</th><th>ржиржорзНржмрж░</th><th>рж╢рждрж╛ржВрж╢</th></tr></thead>
  <tbody>${data.map(r=>`<tr>
    <td><strong>${r.merit_position}</strong></td>
    <td>${r.name}</td>
    <td><span class="badge" style="background:rgba(245,158,11,0.15);color:#FCD34D">Batch ${r.batch}</span></td>
    <td>${r.roll}</td>
    <td>${r.phone||'-'}</td>
    <td>${r.exams_taken}</td>
    <td>${r.total_score}/${r.total_possible}</td>
    <td><strong>${r.percentage}%</strong></td>
  </tr>`).join('')}</tbody></table>`;
}

// INIT
window.addEventListener('load', () => {
  if(sessionStorage.getItem('adminLoggedIn')==='true'){
    document.getElementById('adminLoginWrap').style.display='none';
    document.getElementById('adminApp').style.display='block';
    loadDashboard();
  }
});
</script>
</body>
</html>
