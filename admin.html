<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - UBIQUE MCQ</title>
<link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&family=Baloo+Da+2:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --primary: #4F46E5;
  --primary-dark: #3730A3;
  --primary-light: #818CF8;
  --accent: #F59E0B;
  --success: #10B981;
  --danger: #EF4444;
  --warning: #F97316;
  --bg: #0F0E1A;
  --sidebar: #161528;
  --card: #1E1C35;
  --border: #2D2B4E;
  --text: #E8E6FF;
  --text-muted: #8B89B0;
  --shadow: 0 4px 24px rgba(0,0,0,0.4);
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: 'Hind Siliguri', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; }

/* SIDEBAR */
.sidebar {
  width: 240px; min-height: 100vh;
  background: var(--sidebar);
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
  position: fixed; top:0; left:0; bottom:0;
  z-index: 100;
}
.sidebar-logo {
  padding: 1.5rem 1.2rem;
  font-family: 'Baloo Da 2', cursive;
  font-size: 1.3rem; font-weight: 800;
  color: var(--primary-light);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 0.5rem;
}
.sidebar-label {
  font-size: 0.7rem; font-weight: 600;
  color: var(--text-muted); text-transform: uppercase;
  letter-spacing: 1px; padding: 1rem 1.2rem 0.4rem;
}
.nav-item {
  display: flex; align-items: center; gap: 0.7rem;
  padding: 0.7rem 1.2rem;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.2s;
  border-left: 3px solid transparent;
  font-size: 0.92rem;
  font-weight: 500;
}
.nav-item:hover { background: rgba(79,70,229,0.1); color: var(--text); }
.nav-item.active { background: rgba(79,70,229,0.15); color: var(--primary-light); border-left-color: var(--primary-light); }
.nav-icon { font-size: 1.1rem; }
.sidebar-bottom { margin-top: auto; padding: 1rem 1.2rem; border-top: 1px solid var(--border); }
.admin-info { font-size: 0.82rem; color: var(--text-muted); margin-bottom: 0.6rem; }
.btn-logout-admin {
  width: 100%; padding: 0.5rem;
  background: rgba(239,68,68,0.15);
  border: 1px solid rgba(239,68,68,0.3);
  color: #FCA5A5;
  border-radius: 8px;
  cursor: pointer;
  font-family: 'Hind Siliguri', sans-serif;
  font-size: 0.85rem; font-weight: 600;
  transition: all 0.2s;
}
.btn-logout-admin:hover { background: rgba(239,68,68,0.25); }

/* MAIN */
.main { margin-left: 240px; flex: 1; padding: 2rem; min-height: 100vh; }
.page-header {
  margin-bottom: 1.8rem;
  display: flex; align-items: center; justify-content: space-between;
}
.page-header h1 { font-family: 'Baloo Da 2', cursive; font-size: 1.6rem; font-weight: 700; }
.page-header p { color: var(--text-muted); font-size: 0.9rem; margin-top: 0.2rem; }

/* CARDS */
.card {
  background: var(--card);
  border-radius: 16px;
  border: 1px solid var(--border);
  padding: 1.5rem;
  box-shadow: var(--shadow);
}
.stat-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 1rem; margin-bottom: 1.5rem; }
.stat-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 1.2rem;
  display: flex; flex-direction: column; gap: 0.3rem;
}
.stat-card-val { font-size: 2rem; font-weight: 800; font-family: 'Baloo Da 2', cursive; }
.stat-card-label { font-size: 0.82rem; color: var(--text-muted); }
.stat-c1 .stat-card-val { color: var(--primary-light); }
.stat-c2 .stat-card-val { color: var(--success); }
.stat-c3 .stat-card-val { color: var(--accent); }
.stat-c4 .stat-card-val { color: #F472B6; }

/* TABLE */
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; }
th {
  background: rgba(79,70,229,0.15);
  padding: 0.7rem 1rem;
  text-align: left; font-size: 0.78rem;
  font-weight: 700; color: var(--primary-light);
  text-transform: uppercase; letter-spacing: 0.5px;
  white-space: nowrap;
}
td {
  padding: 0.65rem 1rem;
  font-size: 0.88rem;
  border-bottom: 1px solid rgba(255,255,255,0.04);
  color: var(--text);
}
tr:hover td { background: rgba(79,70,229,0.06); }

/* FORMS */
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
.form-group { margin-bottom: 1rem; }
.form-label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.4rem; }
.form-control {
  width: 100%; padding: 0.65rem 0.9rem;
  background: #2D2B4E;
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text);
  font-family: 'Hind Siliguri', sans-serif;
  font-size: 0.92rem;
  transition: all 0.2s;
}
.form-control:focus { outline: none; border-color: var(--primary-light); background: #3730A3; }
textarea.form-control { min-height: 80px; resize: vertical; }
.form-control option {
  background: #2D2B4E;
  color: var(--text);
}

/* BUTTONS */
.btn {
  padding: 0.55rem 1.2rem;
  border-radius: 10px; border: none;
  font-family: 'Hind Siliguri', sans-serif;
  font-size: 0.88rem; font-weight: 600;
  cursor: pointer; transition: all 0.2s;
  display: inline-flex; align-items: center; gap: 0.4rem;
}
.btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: #fff; }
.btn-primary:hover { box-shadow: 0 4px 12px rgba(79,70,229,0.4); transform: translateY(-1px); }
.btn-success { background: linear-gradient(135deg, var(--success), #059669); color: #fff; }
.btn-success:hover { box-shadow: 0 4px 12px rgba(16,185,129,0.4); }
.btn-danger { background: rgba(239,68,68,0.15); color: #FCA5A5; border: 1px solid rgba(239,68,68,0.3); }
.btn-danger:hover { background: rgba(239,68,68,0.25); }
.btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
.btn-ghost:hover { border-color: var(--primary-light); color: var(--primary-light); }
.btn-sm { padding: 0.3rem 0.75rem; font-size: 0.78rem; }

/* BADGE */
.badge {
  display: inline-block; padding: 0.2rem 0.6rem;
  border-radius: 20px; font-size: 0.72rem; font-weight: 600;
}
.badge-active { background: rgba(16,185,129,0.15); color: #34D399; }
.badge-inactive { background: rgba(239,68,68,0.15); color: #FCA5A5; }
.badge-class { background: rgba(79,70,229,0.2); color: var(--primary-light); }

/* SECTION TABS */
.section { display: none; }
.section.active { display: block; }

/* MODAL */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.7);
  display: none; align-items: center; justify-content: center;
  z-index: 200; padding: 1rem;
}
.modal-overlay.active { display: flex; }
.modal {
  background: var(--card); border-radius: 20px;
  padding: 1.8rem; width: 100%; max-width: 560px;
  border: 1px solid var(--border); box-shadow: var(--shadow);
  max-height: 90vh; overflow-y: auto;
}
.modal h3 { font-size: 1.1rem; font-weight: 700; margin-bottom: 1.2rem; color: var(--primary-light); }
.modal-footer { display: flex; gap: 0.8rem; justify-content: flex-end; margin-top: 1rem; }

/* Q LIST */
.q-item {
  background: rgba(255,255,255,0.04);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 1rem;
  margin-bottom: 0.8rem;
}
.q-item-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
.q-item-text { font-size: 0.9rem; margin-bottom: 0.5rem; }
.q-item-options { display: grid; grid-template-columns: 1fr 1fr; gap: 0.3rem; font-size: 0.8rem; color: var(--text-muted); }
.q-correct { color: var(--success); font-weight: 600; }

/* LOGIN */
.admin-login-wrap {
  min-height: 100vh; display: flex; align-items: center; justify-content: center;
  background: var(--bg);
}
.admin-login-card {
  background: var(--card); border-radius: 20px; padding: 2.5rem;
  width: 100%; max-width: 380px; border: 1px solid var(--border);
}
.admin-login-card h2 {
  font-family: 'Baloo Da 2', cursive; font-size: 1.5rem;
  font-weight: 700; margin-bottom: 1.5rem; color: var(--primary-light);
  text-align: center;
}

/* LOADING */
.loading-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.6);
  display: none; align-items: center; justify-content: center; z-index: 999;
}
.spinner { width: 44px; height: 44px; border: 4px solid rgba(255,255,255,0.15); border-top-color: var(--primary-light); border-radius: 50%; animation: spin 0.7s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

.alert {
  padding: 0.7rem 1rem; border-radius: 10px; font-size: 0.88rem;
  margin-bottom: 1rem; display: none;
}
.alert-error { background: rgba(239,68,68,0.15); color: #FCA5A5; border: 1px solid rgba(239,68,68,0.3); }
.alert-success { background: rgba(16,185,129,0.15); color: #34D399; border: 1px solid rgba(16,185,129,0.3); }
</style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>

<!-- ADMIN LOGIN -->
<div id="adminLoginWrap" class="admin-login-wrap">
  <div class="admin-login-card">
    <h2>üîê Admin Login</h2>
    <div class="form-group">
      <label class="form-label">Username</label>
      <input class="form-control" id="adminUser" type="text" placeholder="admin">
    </div>
    <div class="form-group">
      <label class="form-label">Password</label>
      <input class="form-control" id="adminPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
    <div class="alert alert-error" id="adminLoginError"></div>
    <button class="btn btn-primary" style="width:100%;justify-content:center;padding:0.75rem" onclick="adminLogin()">‡¶≤‡¶ó‡¶ø‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
  </div>
</div>

<!-- MAIN APP -->
<div id="adminApp" style="display:none; width:100%; display:none">

<!-- SIDEBAR -->
<nav class="sidebar">
  <div class="sidebar-logo">‚ö° UBIQUE Admin</div>
  <div class="sidebar-label">‡¶Æ‡ßÇ‡¶≤ ‡¶Æ‡ßá‡¶®‡ßÅ</div>
  <div class="nav-item active" onclick="showSection('dashboard',this)"><span class="nav-icon">üìä</span> ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</div>
  <div class="nav-item" onclick="showSection('students',this)"><span class="nav-icon">üë®‚Äçüéì</span> ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ</div>
  <div class="nav-item" onclick="showSection('exams',this)"><span class="nav-icon">üìã</span> ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ</div>
  <div class="nav-item" onclick="showSection('questions',this)"><span class="nav-icon">‚ùì</span> ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶∏‡¶Æ‡ßÇ‡¶π</div>
  <div class="nav-item" onclick="showSection('results',this)"><span class="nav-icon">üìà</span> ‡¶´‡¶≤‡¶æ‡¶´‡¶≤</div>
  <div class="nav-item" onclick="showSection('merit',this)"><span class="nav-icon">üèÜ</span> ‡¶Æ‡ßá‡¶∞‡¶ø‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</div>
  <div class="sidebar-bottom">
    <div class="admin-info">Admin ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶≤‡¶ó‡¶ø‡¶® ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá‡¶®</div>
    <button class="btn-logout-admin" onclick="adminLogout()">üö™ ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
  </div>
</nav>

<!-- MAIN CONTENT -->
<main class="main">

  <!-- DASHBOARD -->
  <div class="section active" id="sec-dashboard">
    <div class="page-header">
      <div><h1>üìä ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</h1><p>‡¶∏‡¶æ‡¶Æ‡¶ó‡ßç‡¶∞‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶®</p></div>
    </div>
    <div class="stat-grid">
      <div class="stat-card stat-c1"><div class="stat-card-val" id="totalStudents">-</div><div class="stat-card-label">‡¶Æ‡ßã‡¶ü ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ</div></div>
      <div class="stat-card stat-c2"><div class="stat-card-val" id="totalExams">-</div><div class="stat-card-label">‡¶Æ‡ßã‡¶ü ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ</div></div>
      <div class="stat-card stat-c3"><div class="stat-card-val" id="totalQuestions">-</div><div class="stat-card-label">‡¶Æ‡ßã‡¶ü ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®</div></div>
      <div class="stat-card stat-c4"><div class="stat-card-val" id="totalResults">-</div><div class="stat-card-label">‡¶Æ‡ßã‡¶ü ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ</div></div>
    </div>
    <div class="card">
      <h3 style="font-size:1rem;font-weight:700;margin-bottom:1rem;color:var(--primary-light)">üìã ‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶´‡¶≤‡¶æ‡¶´‡¶≤</h3>
      <div class="table-wrap" id="recentResultsTable">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
    </div>
  </div>

  <!-- STUDENTS -->
  <div class="section" id="sec-students">
    <div class="page-header">
      <div><h1>üë®‚Äçüéì ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ</h1><p>‡¶∏‡¶ï‡¶≤ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø</p></div>
      <div style="display:flex;gap:0.6rem">
        <button class="btn btn-ghost" onclick="openModal('bulkImportModal')">üì• CSV Import</button>
        <button class="btn btn-primary" onclick="openModal('addStudentModal')">+ ‡¶®‡¶§‡ßÅ‡¶® ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ</button>
      </div>
    </div>
    <div class="card">
      <div style="display:flex;gap:0.8rem;margin-bottom:1rem;flex-wrap:wrap">
        <select class="form-control" id="filterClass" style="width:auto" onchange="loadStudents()">
          <option value="">‡¶∏‡¶¨ ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏</option>
          <option value="6">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡ß¨</option><option value="7">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡ß≠</option>
          <option value="8">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡ßÆ</option><option value="9">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡ßØ</option>
          <option value="10">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡ßß‡ß¶</option>
        </select>
        <select class="form-control" id="filterBatch" style="width:auto" onchange="loadStudents()">
          <option value="">‡¶∏‡¶¨ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö</option>
          <option value="A">Batch A</option>
          <option value="B">Batch B</option>
          <option value="C">Batch C</option>
          <option value="D">Batch D</option>
          <option value="E">Batch E</option>
        </select>
      </div>
      <div class="table-wrap" id="studentsTable">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
    </div>
  </div>

  <!-- EXAMS -->
  <div class="section" id="sec-exams">
    <div class="page-header">
      <div><h1>üìã ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ</h1><p>‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ì ‡¶™‡¶∞‡¶ø‡¶ö‡¶æ‡¶≤‡¶®‡¶æ</p></div>
      <button class="btn btn-primary" onclick="openModal('addExamModal')">+ ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ</button>
    </div>
    <div class="card">
      <div class="table-wrap" id="examsTable">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
    </div>
  </div>

  <!-- QUESTIONS -->
  <div class="section" id="sec-questions">
    <div class="page-header">
      <div><h1>‚ùì ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶∏‡¶Æ‡ßÇ‡¶π</h1><p>‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‡¶ì ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</p></div>
    </div>
    <div class="card" style="margin-bottom:1rem">
      <div style="display:flex;gap:0.8rem;align-items:center;flex-wrap:wrap">
        <select class="form-control" id="qExamFilter" style="width:auto" onchange="loadQuestions()">
          <option value="">‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡¶®</option>
        </select>
        <button class="btn btn-primary btn-sm" id="addQBtn" onclick="openAddQuestion()" style="display:none">+ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Ø‡ßã‡¶ó</button>
      </div>
    </div>
    <div id="questionsList">‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡¶®</div>
  </div>

  <!-- RESULTS -->
  <div class="section" id="sec-results">
    <div class="page-header">
      <div><h1>üìà ‡¶´‡¶≤‡¶æ‡¶´‡¶≤</h1><p>‡¶∏‡¶ï‡¶≤ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤</p></div>
    </div>
    <div class="card">
      <div style="display:flex;gap:0.8rem;margin-bottom:1rem;flex-wrap:wrap">
        <select class="form-control" id="resultExamFilter" style="width:auto" onchange="loadResults()">
          <option value="">‡¶∏‡¶¨ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ</option>
        </select>
        <select class="form-control" id="resultClassFilter" style="width:auto" onchange="loadResults()">
          <option value="">‡¶∏‡¶¨ ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏</option>
          <option value="6">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡ß¨</option><option value="7">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡ß≠</option>
          <option value="8">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡ßÆ</option><option value="9">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡ßØ</option>
          <option value="10">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡ßß‡ß¶</option>
        </select>
      </div>
      <div class="table-wrap" id="resultsTable">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
    </div>
  </div>

  <!-- MERIT -->
  <div class="section" id="sec-merit">
    <div class="page-header">
      <div><h1>üèÜ ‡¶Æ‡ßá‡¶∞‡¶ø‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</h1><p>‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶Æ‡ßá‡¶∞‡¶ø‡¶ü ‡¶™‡¶ú‡¶ø‡¶∂‡¶®</p></div>
    </div>
    <div class="card">
      <div style="display:flex;gap:0.8rem;margin-bottom:1rem;flex-wrap:wrap">
        <select class="form-control" id="meritClassFilter" style="width:auto" onchange="loadAdminMerit()">
          <option value="6">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡ß¨</option><option value="7">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡ß≠</option>
          <option value="8">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡ßÆ</option><option value="9">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡ßØ</option>
          <option value="10">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡ßß‡ß¶</option>
        </select>
        <select class="form-control" id="meritBatchFilter" style="width:auto" onchange="loadAdminMerit()">
          <option value="A">Batch A</option>
          <option value="B">Batch B</option>
          <option value="C">Batch C</option>
          <option value="D">Batch D</option>
          <option value="E">Batch E</option>
        </select>
        <select class="form-control" id="meritMonthFilter" style="width:auto" onchange="loadAdminMerit()">
          <option value="February 2025">‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø ‡ß®‡ß¶‡ß®‡ß´</option>
          <option value="March 2025">‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö ‡ß®‡ß¶‡ß®‡ß´</option>
        </select>
      </div>
      <div class="table-wrap" id="meritTable">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
    </div>
  </div>

</main>
</div>

<!-- ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ -->

<!-- Add Student -->
<div class="modal-overlay" id="addStudentModal">
  <div class="modal">
    <h3>‚ûï ‡¶®‡¶§‡ßÅ‡¶® ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
    <div class="alert alert-error" id="addStudentError"></div>
    <div class="alert alert-success" id="addStudentSuccess"></div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">‡¶®‡¶æ‡¶Æ</label>
        <input class="form-control" id="sName" placeholder="‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ">
      </div>
      <div class="form-group">
        <label class="form-label">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏</label>
        <select class="form-control" id="sClass">
          <option value="6">‡ß¨</option><option value="7">‡ß≠</option>
          <option value="8">‡ßÆ</option><option value="9">‡ßØ</option><option value="10">‡ßß‡ß¶</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">‡¶∞‡ßã‡¶≤</label>
        <input class="form-control" id="sRoll" type="number" placeholder="‡¶∞‡ßã‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞">
      </div>
      <div class="form-group">
        <label class="form-label">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</label>
        <input class="form-control" id="sPhone" placeholder="01XXXXXXXXX">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö</label>
      <select class="form-control" id="sBatch">
        <option value="A">Batch A</option>
        <option value="B">Batch B</option>
        <option value="C">Batch C</option>
        <option value="D">Batch D</option>
        <option value="E">Batch E</option>
      </select>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('addStudentModal')">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
      <button class="btn btn-success" onclick="addStudent()">‚úì ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
  </div>
</div>

<!-- Add Exam -->
<div class="modal-overlay" id="addExamModal">
  <div class="modal">
    <h3>üìã ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
    <div class="alert alert-error" id="addExamError"></div>
    <div class="form-row">
      <div class="form-group" style="grid-column:1/-1">
        <label class="form-label">‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ</label>
        <input class="form-control" id="eTitle" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶∏‡¶™‡ßç‡¶§‡¶æ‡¶π ‡ßß - ‡¶ó‡¶£‡¶ø‡¶§ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º</label>
        <input class="form-control" id="eSubject" placeholder="‡¶ó‡¶£‡¶ø‡¶§, ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®...">
      </div>
      <div class="form-group">
        <label class="form-label">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏</label>
        <select class="form-control" id="eClass">
          <option value="6">‡ß¨</option><option value="7">‡ß≠</option>
          <option value="8">‡ßÆ</option><option value="9">‡ßØ</option><option value="10">‡ßß‡ß¶</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">‡¶∏‡¶™‡ßç‡¶§‡¶æ‡¶π ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label>
        <input class="form-control" id="eWeek" type="number" value="1" min="1">
      </div>
      <div class="form-group">
        <label class="form-label">‡¶Æ‡¶æ‡¶∏</label>
        <input class="form-control" id="eMonth" placeholder="February 2025">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">‡¶∏‡¶Æ‡¶Ø‡¶º (‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü)</label>
        <input class="form-control" id="eDuration" type="number" value="30" min="5">
      </div>
      <div class="form-group">
        <label class="form-label">‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö</label>
        <select class="form-control" id="eBatch">
          <option value="A">Batch A</option>
          <option value="B">Batch B</option>
          <option value="C">Batch C</option>
          <option value="D">Batch D</option>
          <option value="E">Batch E</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
        <input class="form-control" id="eStart" type="datetime-local">
      </div>
      <div class="form-group">
        <label class="form-label">‡¶∂‡ßá‡¶∑ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
        <input class="form-control" id="eEnd" type="datetime-local">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('addExamModal')">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
      <button class="btn btn-success" onclick="addExam()">‚úì ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
  </div>
</div>

<!-- Add Question -->
<div class="modal-overlay" id="addQuestionModal">
  <div class="modal">
    <h3>‚ùì ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
    <div class="alert alert-error" id="addQError"></div>
    <div class="form-group">
      <label class="form-label">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶ß‡¶∞‡¶®</label>
      <select class="form-control" id="qType" onchange="toggleQuestionType()">
        <option value="mcq">MCQ (‡ß™‡¶ü‡¶ø ‡¶Ö‡¶™‡¶∂‡¶®)</option>
        <option value="truefalse">‡¶∏‡¶§‡ßç‡¶Ø / ‡¶Æ‡¶ø‡¶•‡ßç‡¶Ø‡¶æ</option>
        <option value="fillinblank">‡¶∂‡ßÇ‡¶®‡ßç‡¶Ø‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶™‡ßÇ‡¶∞‡¶£ (Dropdown)</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® <span style="color:var(--text-muted);font-weight:400">(KaTeX: \frac{1}{2}, \sqrt{4}, ‡¶∂‡ßÇ‡¶®‡ßç‡¶Ø‡¶∏‡ßç‡¶•‡¶æ‡¶®‡ßá ___ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®)</span></label>
      <textarea class="form-control" id="qText" placeholder="‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."></textarea>
    </div>

    <!-- MCQ Options -->
    <div id="mcqOptions">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">‡¶Ö‡¶™‡¶∂‡¶® A</label>
          <input class="form-control" id="qA" placeholder="‡¶Ö‡¶™‡¶∂‡¶® A">
        </div>
        <div class="form-group">
          <label class="form-label">‡¶Ö‡¶™‡¶∂‡¶® B</label>
          <input class="form-control" id="qB" placeholder="‡¶Ö‡¶™‡¶∂‡¶® B">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">‡¶Ö‡¶™‡¶∂‡¶® C</label>
          <input class="form-control" id="qC" placeholder="‡¶Ö‡¶™‡¶∂‡¶® C">
        </div>
        <div class="form-group">
          <label class="form-label">‡¶Ö‡¶™‡¶∂‡¶® D</label>
          <input class="form-control" id="qD" placeholder="‡¶Ö‡¶™‡¶∂‡¶® D">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">‡¶∏‡¶†‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡¶∞</label>
          <select class="form-control" id="qCorrect">
            <option value="a">A</option><option value="b">B</option>
            <option value="c">C</option><option value="d">D</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶ï‡ßç‡¶∞‡¶Æ</label>
          <input class="form-control" id="qOrder" type="number" value="1" min="1">
        </div>
      </div>
    </div>

    <!-- True/False Options -->
    <div id="tfOptions" style="display:none">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">"‡¶∏‡¶§‡ßç‡¶Ø" ‡¶¨‡¶æ‡¶ü‡¶®‡ßá‡¶∞ ‡¶≤‡ßá‡¶ñ‡¶æ</label>
          <input class="form-control" id="qTFTrue" value="‡¶∏‡¶§‡ßç‡¶Ø" placeholder="‡¶∏‡¶§‡ßç‡¶Ø">
        </div>
        <div class="form-group">
          <label class="form-label">"‡¶Æ‡¶ø‡¶•‡ßç‡¶Ø‡¶æ" ‡¶¨‡¶æ‡¶ü‡¶®‡ßá‡¶∞ ‡¶≤‡ßá‡¶ñ‡¶æ</label>
          <input class="form-control" id="qTFFalse" value="‡¶Æ‡¶ø‡¶•‡ßç‡¶Ø‡¶æ" placeholder="‡¶Æ‡¶ø‡¶•‡ßç‡¶Ø‡¶æ">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">‡¶∏‡¶†‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡¶∞</label>
          <select class="form-control" id="qTFCorrect">
            <option value="‡¶∏‡¶§‡ßç‡¶Ø">‡¶∏‡¶§‡ßç‡¶Ø</option>
            <option value="‡¶Æ‡¶ø‡¶•‡ßç‡¶Ø‡¶æ">‡¶Æ‡¶ø‡¶•‡ßç‡¶Ø‡¶æ</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶ï‡ßç‡¶∞‡¶Æ</label>
          <input class="form-control" id="qTFOrder" type="number" value="1" min="1">
        </div>
      </div>
    </div>

    <!-- Fill in Blank Options -->
    <div id="fibOptions" style="display:none">
      <p style="font-size:0.82rem;color:var(--text-muted);margin-bottom:0.8rem">
        ‡ß®-‡ß™‡¶ü‡¶ø ‡¶Ö‡¶™‡¶∂‡¶® ‡¶¶‡¶ø‡¶®‡•§ ‡¶Ø‡ßá‡¶ü‡¶æ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶∏‡ßá‡¶ü‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
      </p>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">‡¶Ö‡¶™‡¶∂‡¶® A</label>
          <input class="form-control" id="qFIBA" placeholder="‡¶Ö‡¶™‡¶∂‡¶® A">
        </div>
        <div class="form-group">
          <label class="form-label">‡¶Ö‡¶™‡¶∂‡¶® B</label>
          <input class="form-control" id="qFIBB" placeholder="‡¶Ö‡¶™‡¶∂‡¶® B">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">‡¶Ö‡¶™‡¶∂‡¶® C <span style="color:var(--text-muted)">(‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)</span></label>
          <input class="form-control" id="qFIBC" placeholder="‡¶Ö‡¶™‡¶∂‡¶® C (‡¶®‡¶æ ‡¶¶‡¶ø‡¶≤‡ßá ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®)">
        </div>
        <div class="form-group">
          <label class="form-label">‡¶Ö‡¶™‡¶∂‡¶® D <span style="color:var(--text-muted)">(‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)</span></label>
          <input class="form-control" id="qFIBD" placeholder="‡¶Ö‡¶™‡¶∂‡¶® D (‡¶®‡¶æ ‡¶¶‡¶ø‡¶≤‡ßá ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®)">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">‡¶∏‡¶†‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡¶∞</label>
          <select class="form-control" id="qFIBCorrect">
            <option value="a">A</option><option value="b">B</option>
            <option value="c">C</option><option value="d">D</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶ï‡ßç‡¶∞‡¶Æ</label>
          <input class="form-control" id="qFIBOrder" type="number" value="1" min="1">
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('addQuestionModal')">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
      <button class="btn btn-success" onclick="addQuestion()">‚úì ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
  </div>
</div>

<!-- Bulk Import Modal -->
<div class="modal-overlay" id="bulkImportModal">
  <div class="modal" style="max-width:620px">
    <h3>üì• CSV ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶¨‡¶æ‡¶≤‡ßç‡¶ï ‡¶≠‡¶∞‡ßç‡¶§‡¶ø</h3>
    <div style="background:rgba(79,70,229,0.1);border:1px solid var(--border);border-radius:10px;padding:1rem;margin-bottom:1rem;font-size:0.85rem;color:var(--text-muted)">
      <strong style="color:var(--primary-light)">CSV ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü:</strong><br>
      ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶≤‡¶æ‡¶á‡¶® header (skip ‡¶π‡¶¨‡ßá)<br>
      <code style="color:#34D399">‡¶®‡¶æ‡¶Æ,‡¶ï‡ßç‡¶≤‡¶æ‡¶∏,‡¶∞‡ßã‡¶≤,‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤,‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö</code><br><br>
      ‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£:<br>
      <code style="color:#FCD34D">
        ‡¶∞‡¶æ‡¶π‡ßá‡¶≤‡¶æ ‡¶¨‡ßá‡¶ó‡¶Æ,6,1,01711000001,A<br>
        ‡¶ï‡¶∞‡¶ø‡¶Æ ‡¶π‡ßã‡¶∏‡ßá‡¶®,7,2,01711000002,B
      </code>
    </div>

    <div style="margin-bottom:1rem">
      <label class="form-label">CSV ‡¶´‡¶æ‡¶á‡¶≤ ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡¶®</label>
      <input type="file" id="csvFile" accept=".csv" class="form-control" onchange="previewCSV()">
    </div>

    <div id="csvPreview" style="display:none;margin-bottom:1rem">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem">
        <span style="font-size:0.85rem;font-weight:600;color:var(--primary-light)" id="csvPreviewLabel">‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â</span>
        <span class="badge badge-active" id="csvCount"></span>
      </div>
      <div style="max-height:200px;overflow-y:auto;border:1px solid var(--border);border-radius:10px">
        <table style="font-size:0.8rem">
          <thead><tr><th>‡¶®‡¶æ‡¶Æ</th><th>‡¶ï‡ßç‡¶≤‡¶æ‡¶∏</th><th>‡¶∞‡ßã‡¶≤</th><th>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th><th>‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö</th><th>‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ</th></tr></thead>
          <tbody id="csvPreviewBody"></tbody>
        </table>
      </div>
    </div>

    <div class="alert alert-error" id="bulkError"></div>
    <div class="alert alert-success" id="bulkSuccess"></div>

    <div style="background:rgba(255,255,255,0.04);border-radius:10px;padding:0.8rem;margin-bottom:1rem;font-size:0.82rem;color:var(--text-muted)">
      ‚ö†Ô∏è ‡¶è‡¶ï‡¶á class+roll ‡¶¨‡¶æ phone number ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∏‡ßá‡¶á row skip ‡¶π‡¶¨‡ßá, ‡¶¨‡¶æ‡¶ï‡¶ø‡¶ó‡ßÅ‡¶≤‡ßã import ‡¶π‡¶¨‡ßá‡•§
    </div>

    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('bulkImportModal');resetCSV()">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
      <a id="csvTemplateLink" style="display:none"></a>
      <button class="btn btn-ghost" onclick="downloadTemplate()">üìÑ Template Download</button>
      <button class="btn btn-success" id="importBtn" onclick="importStudents()" disabled>üì• Import ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://cjeaahqwcejxqfiascpz.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNqZWFhaHF3Y2VqeHFmaWFzY3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMjA1NjcsImV4cCI6MjA4NzY5NjU2N30.tNRinQBmUfnwTV_Qh6G6gwaKThXG1AZW2v-t2qWqEK8';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let selectedExamForQ = null;
let parsedCSVData = [];

function loading(s) { document.getElementById('loadingOverlay').style.display = s?'flex':'none'; }
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
function showAlert(id, msg, type='error') {
  const el = document.getElementById(id);
  if(!el) return;
  el.textContent = msg; el.style.display='block'; el.className=`alert alert-${type}`;
  setTimeout(()=>{ el.style.display='none'; }, 4000);
}

// ‚îÄ‚îÄ CSV IMPORT ‚îÄ‚îÄ
function previewCSV() {
  const file = document.getElementById('csvFile').files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const lines = e.target.result.split('\n').filter(l=>l.trim());
    parsedCSVData = [];
    const tbody = document.getElementById('csvPreviewBody');
    tbody.innerHTML = '';
    // Skip header row
    for(let i=1; i<lines.length; i++) {
      const cols = lines[i].split(',').map(c=>c.trim().replace(/"/g,''));
      if(cols.length < 4) continue;
      const [name, cls, roll, phone, batch='A'] = cols;
      if(!name||!cls||!roll||!phone) continue;
      const valid = name.length>0 && ['6','7','8','9','10'].includes(cls) && roll.length>0 && phone.length>=11;
      parsedCSVData.push({name,class:cls,roll,phone,batch:batch||'A',valid});
      tbody.innerHTML += `<tr>
        <td>${name}</td><td>${cls}</td><td>${roll}</td>
        <td>${phone}</td><td>${batch||'A'}</td>
        <td>${valid?'<span class="badge badge-active">‚úì</span>':'<span class="badge badge-inactive">‚úó</span>'}</td>
      </tr>`;
    }
    const validCount = parsedCSVData.filter(r=>r.valid).length;
    document.getElementById('csvPreview').style.display = 'block';
    document.getElementById('csvCount').textContent = `${validCount} ‡¶ú‡¶® valid`;
    document.getElementById('importBtn').disabled = validCount === 0;
  };
  reader.readAsText(file, 'UTF-8');
}

async function importStudents() {
  const validRows = parsedCSVData.filter(r=>r.valid);
  if(!validRows.length) return;
  loading(true);
  let success=0, skipped=0;
  for(const row of validRows) {
    const {error} = await sb.from('students').insert({
      name:row.name, class:row.class, roll:row.roll,
      phone:row.phone, batch:row.batch
    });
    if(error) skipped++;
    else success++;
  }
  loading(false);
  showAlert('bulkSuccess', `‚úÖ ${success} ‡¶ú‡¶® import ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ${skipped} ‡¶ú‡¶® skip ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá (duplicate)‡•§`, 'success');
  setTimeout(()=>{ closeModal('bulkImportModal'); resetCSV(); loadStudents(); }, 2500);
}

function resetCSV() {
  parsedCSVData = [];
  document.getElementById('csvFile').value = '';
  document.getElementById('csvPreview').style.display = 'none';
  document.getElementById('importBtn').disabled = true;
}

function downloadTemplate() {
  const csv = `‡¶®‡¶æ‡¶Æ,‡¶ï‡ßç‡¶≤‡¶æ‡¶∏,‡¶∞‡ßã‡¶≤,‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤,‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö\n‡¶∞‡¶æ‡¶π‡ßá‡¶≤‡¶æ ‡¶¨‡ßá‡¶ó‡¶Æ,6,1,01711000001,A\n‡¶ï‡¶∞‡¶ø‡¶Æ ‡¶π‡ßã‡¶∏‡ßá‡¶®,7,2,01711000002,B\n‡¶∏‡ßÅ‡¶Æ‡¶æ‡¶á‡¶Ø‡¶º‡¶æ ‡¶Ü‡¶ï‡ßç‡¶§‡¶æ‡¶∞,8,3,01711000003,A`;
  const blob = new Blob(['\uFEFF'+csv], {type:'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download='students_template.csv'; a.click();
  URL.revokeObjectURL(url);
}

// ‚îÄ‚îÄ ADMIN LOGIN ‚îÄ‚îÄ
async function adminLogin() {
  const user = document.getElementById('adminUser').value.trim();
  const pass = document.getElementById('adminPass').value.trim();
  if(!user||!pass){showAlert('adminLoginError','‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®');return;}
  loading(true);
  const {data} = await sb.from('admins').select('*').eq('username',user).eq('password_hash',pass).single();
  loading(false);
  if(!data){showAlert('adminLoginError','‡¶≠‡ßÅ‡¶≤ username ‡¶Ö‡¶•‡¶¨‡¶æ password');return;}
  sessionStorage.setItem('adminLoggedIn','true');
  document.getElementById('adminLoginWrap').style.display='none';
  document.getElementById('adminApp').style.display='flex';
  loadDashboard();
}
function adminLogout(){
  sessionStorage.removeItem('adminLoggedIn');
  location.reload();
}

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ
function showSection(name, el) {
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('sec-'+name).classList.add('active');
  el.classList.add('active');
  const loaders = {students:loadStudents,exams:loadExams,questions:loadQExamList,results:loadResultFilters,merit:loadAdminMerit};
  if(loaders[name]) loaders[name]();
}

// ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ
async function loadDashboard() {
  const [s,e,q,r] = await Promise.all([
    sb.from('students').select('id',{count:'exact',head:true}),
    sb.from('exams').select('id',{count:'exact',head:true}),
    sb.from('questions').select('id',{count:'exact',head:true}),
    sb.from('results').select('id',{count:'exact',head:true})
  ]);
  document.getElementById('totalStudents').textContent = s.count||0;
  document.getElementById('totalExams').textContent = e.count||0;
  document.getElementById('totalQuestions').textContent = q.count||0;
  document.getElementById('totalResults').textContent = r.count||0;

  const {data:recent} = await sb.from('results')
    .select('*, students(name,class,roll,batch), exams(title,batch)')
    .order('submitted_at',{ascending:false}).limit(10);
  const wrap = document.getElementById('recentResultsTable');
  if(!recent||!recent.length){wrap.innerHTML='<p style="color:var(--text-muted);padding:1rem">‡¶ï‡ßã‡¶®‡ßã ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶®‡ßá‡¶á</p>';return;}
  wrap.innerHTML = `<table><thead><tr><th>‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ</th><th>‡¶ï‡ßç‡¶≤‡¶æ‡¶∏</th><th>‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö</th><th>‡¶∞‡ßã‡¶≤</th><th>‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ</th><th>‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</th><th>‡¶∂‡¶§‡¶æ‡¶Ç‡¶∂</th><th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th></tr></thead>
  <tbody>${recent.map(r=>`<tr>
    <td>${r.students?.name||'-'}</td>
    <td><span class="badge badge-class">${r.students?.class||'-'}</span></td>
    <td><span class="badge" style="background:rgba(245,158,11,0.15);color:#FCD34D">Batch ${r.students?.batch||'-'}</span></td>
    <td>${r.students?.roll||'-'}</td>
    <td>${r.exams?.title||'-'}</td>
    <td><strong>${r.score}/${r.total_questions}</strong></td>
    <td>${Math.round(r.score/r.total_questions*100)}%</td>
    <td>${new Date(r.submitted_at).toLocaleDateString('bn-BD')}</td>
  </tr>`).join('')}</tbody></table>`;
}

// ‚îÄ‚îÄ STUDENTS ‚îÄ‚îÄ
async function loadStudents() {
  const cls = document.getElementById('filterClass').value;
  const batch = document.getElementById('filterBatch').value;
  let q = sb.from('students').select('*').order('class').order('batch').order('roll');
  if(cls) q = q.eq('class',cls);
  if(batch) q = q.eq('batch',batch);
  const {data} = await q;
  const wrap = document.getElementById('studentsTable');
  if(!data||!data.length){wrap.innerHTML='<p style="padding:1rem;color:var(--text-muted)">‡¶ï‡ßã‡¶®‡ßã ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ ‡¶®‡ßá‡¶á</p>';return;}
  wrap.innerHTML = `<table><thead><tr><th>‡¶®‡¶æ‡¶Æ</th><th>‡¶ï‡ßç‡¶≤‡¶æ‡¶∏</th><th>‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö</th><th>‡¶∞‡ßã‡¶≤</th><th>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th><th>‡¶Ø‡ßã‡¶ó‡¶¶‡¶æ‡¶®</th><th>‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</th></tr></thead>
  <tbody>${data.map(s=>`<tr>
    <td><strong>${s.name}</strong></td>
    <td><span class="badge badge-class">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ${s.class}</span></td>
    <td><span class="badge" style="background:rgba(245,158,11,0.15);color:#FCD34D">Batch ${s.batch}</span></td>
    <td>${s.roll}</td>
    <td>${s.phone}</td>
    <td>${new Date(s.created_at).toLocaleDateString('bn-BD')}</td>
    <td><button class="btn btn-danger btn-sm" onclick="deleteStudent('${s.id}','${s.name}')">üóë</button></td>
  </tr>`).join('')}</tbody></table>`;
}

async function addStudent() {
  const name=document.getElementById('sName').value.trim();
  const cls=document.getElementById('sClass').value;
  const roll=document.getElementById('sRoll').value.trim();
  const phone=document.getElementById('sPhone').value.trim();
  const batch=document.getElementById('sBatch').value;
  if(!name||!roll||!phone){showAlert('addStudentError','‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®');return;}
  loading(true);
  const {error} = await sb.from('students').insert({name,class:cls,roll,phone,batch});
  loading(false);
  if(error){showAlert('addStudentError','‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: '+error.message);return;}
  showAlert('addStudentSuccess','‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ ‡¶Ø‡ßã‡¶ó ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!','success');
  document.getElementById('sName').value='';document.getElementById('sRoll').value='';document.getElementById('sPhone').value='';
  setTimeout(()=>closeModal('addStudentModal'),1500);
  loadStudents();
}

async function deleteStudent(id,name) {
  if(!confirm(`"${name}" ‡¶ï‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?`)) return;
  loading(true);
  await sb.from('students').delete().eq('id',id);
  loading(false);
  loadStudents();
}

// ‚îÄ‚îÄ EXAMS ‚îÄ‚îÄ
async function loadExams() {
  const {data} = await sb.from('exams').select('*').order('created_at',{ascending:false});
  const wrap = document.getElementById('examsTable');
  if(!data||!data.length){wrap.innerHTML='<p style="padding:1rem;color:var(--text-muted)">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶®‡ßá‡¶á</p>';return;}
  wrap.innerHTML = `<table><thead><tr><th>‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ</th><th>‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º</th><th>‡¶ï‡ßç‡¶≤‡¶æ‡¶∏</th><th>‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö</th><th>‡¶∏‡¶™‡ßç‡¶§‡¶æ‡¶π</th><th>‡¶∏‡¶Æ‡¶Ø‡¶º</th><th>‡¶∂‡ßá‡¶∑ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th>‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ</th><th>‡¶ï‡¶æ‡¶ú</th></tr></thead>
  <tbody>${data.map(e=>{
    const expired = new Date(e.end_date)<new Date();
    return `<tr>
      <td><strong>${e.title}</strong></td>
      <td>${e.subject}</td>
      <td><span class="badge badge-class">${e.class}</span></td>
      <td><span class="badge" style="background:rgba(245,158,11,0.15);color:#FCD34D">Batch ${e.batch||'A'}</span></td>
      <td>‡¶∏‡¶™‡ßç‡¶§‡¶æ‡¶π ${e.week_number}</td>
      <td>${e.duration_minutes} ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü</td>
      <td>${new Date(e.end_date).toLocaleDateString('bn-BD')}</td>
      <td><span class="badge ${expired?'badge-inactive':'badge-active'}">${expired?'‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶ ‡¶∂‡ßá‡¶∑':'‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º'}</span></td>
      <td><button class="btn btn-danger btn-sm" onclick="deleteExam('${e.id}')">üóë</button></td>
    </tr>`;
  }).join('')}</tbody></table>`;
}

async function addExam() {
  const title=document.getElementById('eTitle').value.trim();
  const subject=document.getElementById('eSubject').value.trim();
  const cls=document.getElementById('eClass').value;
  const week=parseInt(document.getElementById('eWeek').value);
  const month=document.getElementById('eMonth').value.trim();
  const dur=parseInt(document.getElementById('eDuration').value);
  const batch=document.getElementById('eBatch').value;
  const start=document.getElementById('eStart').value;
  const end=document.getElementById('eEnd').value;
  if(!title||!subject||!month||!start||!end){showAlert('addExamError','‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®');return;}
  loading(true);
  const {error} = await sb.from('exams').insert({title,subject,class:cls,week_number:week,month,duration_minutes:dur,batch,start_date:new Date(start).toISOString(),end_date:new Date(end).toISOString()});
  loading(false);
  if(error){showAlert('addExamError','‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: '+error.message);return;}
  closeModal('addExamModal');
  loadExams();
}

async function deleteExam(id) {
  if(!confirm('‡¶è‡¶á ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®? ‡¶∏‡¶¨ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ì ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§')) return;
  loading(true);
  await sb.from('exams').delete().eq('id',id);
  loading(false);
  loadExams();
}

// ‚îÄ‚îÄ QUESTIONS ‚îÄ‚îÄ
async function loadQExamList() {
  const {data} = await sb.from('exams').select('id,title,class,batch').order('created_at',{ascending:false});
  const sel = document.getElementById('qExamFilter');
  sel.innerHTML = '<option value="">‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡¶®</option>';
  (data||[]).forEach(e=>{ sel.innerHTML += `<option value="${e.id}">${e.title} (‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ${e.class}, Batch ${e.batch||'A'})</option>`; });
}

async function loadQuestions() {
  const examId = document.getElementById('qExamFilter').value;
  document.getElementById('addQBtn').style.display = examId?'inline-flex':'none';
  selectedExamForQ = examId;
  if(!examId){document.getElementById('questionsList').innerHTML='<p style="color:var(--text-muted)">‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡¶®</p>';return;}
  const {data} = await sb.from('questions').select('*').eq('exam_id',examId).order('question_order');
  const wrap = document.getElementById('questionsList');
  if(!data||!data.length){wrap.innerHTML='<div class="card"><p style="color:var(--text-muted)">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶®‡ßá‡¶á‡•§ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p></div>';return;}
  wrap.innerHTML = data.map((q,i)=>{
    const typeBadge = {
      mcq: '<span style="background:rgba(124,58,237,0.2);color:#A78BFA;padding:0.1rem 0.5rem;border-radius:20px;font-size:0.7rem;font-weight:700">MCQ</span>',
      truefalse: '<span style="background:rgba(16,185,129,0.2);color:#34D399;padding:0.1rem 0.5rem;border-radius:20px;font-size:0.7rem;font-weight:700">‡¶∏‡¶§‡ßç‡¶Ø/‡¶Æ‡¶ø‡¶•‡ßç‡¶Ø‡¶æ</span>',
      fitb: '<span style="background:rgba(245,158,11,0.2);color:#FCD34D;padding:0.1rem 0.5rem;border-radius:20px;font-size:0.7rem;font-weight:700">‡¶∂‡ßÇ‡¶®‡ßç‡¶Ø‡¶∏‡ßç‡¶•‡¶æ‡¶®</span>',
      fillinblank: '<span style="background:rgba(245,158,11,0.2);color:#FCD34D;padding:0.1rem 0.5rem;border-radius:20px;font-size:0.7rem;font-weight:700">‡¶∂‡ßÇ‡¶®‡ßç‡¶Ø‡¶∏‡ßç‡¶•‡¶æ‡¶®</span>'
    };
    const type = q.question_type || 'mcq';
    let optionsHtml = '';
    if (type === 'truefalse') {
      const ca = q.correct_answer;
      optionsHtml = `<span class="${ca===q.option_a||ca==='‡¶∏‡¶§‡ßç‡¶Ø'?'q-correct':''}">‚úÖ ${q.option_a||'‡¶∏‡¶§‡ßç‡¶Ø'}</span>
         <span class="${ca===q.option_b||ca==='‡¶Æ‡¶ø‡¶•‡ßç‡¶Ø‡¶æ'?'q-correct':''}">‚ùå ${q.option_b||'‡¶Æ‡¶ø‡¶•‡ßç‡¶Ø‡¶æ'}</span>`;
    } else if (type === 'fitb') {
      const ca = q.correct_answer;
      optionsHtml = [q.option_a,q.option_b,q.option_c,q.option_d].filter(Boolean).map((o,idx)=>
        `<span class="${ca===o?'q-correct':''}">${'ABCD'[idx]}: ${o}</span>`).join('');
    } else {
      optionsHtml = `<span class="${q.correct_answer==='a'?'q-correct':''}">A: ${q.option_a||''}</span>
         <span class="${q.correct_answer==='b'?'q-correct':''}">B: ${q.option_b||''}</span>
         ${q.option_c?`<span class="${q.correct_answer==='c'?'q-correct':''}">C: ${q.option_c}</span>`:''}
         ${q.option_d?`<span class="${q.correct_answer==='d'?'q-correct':''}">D: ${q.option_d}</span>`:''}`;
    }
    return `
    <div class="q-item">
      <div class="q-item-header">
        <span style="display:flex;align-items:center;gap:0.5rem">
          <span style="font-size:0.78rem;color:var(--primary-light);font-weight:600">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ${i+1}</span>
          ${typeBadge[type]||typeBadge.mcq}
        </span>
        <button class="btn btn-danger btn-sm" onclick="deleteQuestion('${q.id}')">üóë ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
      </div>
      <div class="q-item-text">${q.question_text}</div>
      <div class="q-item-options">${optionsHtml}</div>
    </div>`;
  }).join('');
}

function toggleQuestionType() {
  const type = document.getElementById('qType').value;
  document.getElementById('mcqOptions').style.display = type === 'mcq' ? 'block' : 'none';
  document.getElementById('tfOptions').style.display = type === 'truefalse' ? 'block' : 'none';
  document.getElementById('fibOptions').style.display = type === 'fillinblank' ? 'block' : 'none';
}

function openAddQuestion() {
  if(!selectedExamForQ){alert('‡¶Ü‡¶ó‡ßá ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡¶®');return;}
  document.getElementById('qType').value = 'mcq';
  toggleQuestionType();
  openModal('addQuestionModal');
}

async function addQuestion() {
  const type = document.getElementById('qType').value;
  const text = document.getElementById('qText').value.trim();
  if(!text) { showAlert('addQError','‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®'); return; }

  // admin ‡¶è fillinblank ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ DB ‡¶§‡ßá fitb
  const dbType = type === 'fillinblank' ? 'fitb' : type;
  let payload = { exam_id: selectedExamForQ, question_text: text, question_type: dbType };

  if (type === 'mcq') {
    const a=document.getElementById('qA').value.trim();
    const b=document.getElementById('qB').value.trim();
    const c=document.getElementById('qC').value.trim();
    const d=document.getElementById('qD').value.trim();
    if(!a||!b||!c||!d){ showAlert('addQError','‡¶∏‡¶¨ ‡¶Ö‡¶™‡¶∂‡¶® ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®'); return; }
    payload = {...payload, option_a:a, option_b:b, option_c:c, option_d:d,
      correct_answer: document.getElementById('qCorrect').value,
      question_order: parseInt(document.getElementById('qOrder').value)||1 };

  } else if (type === 'truefalse') {
    const trueLabel = document.getElementById('qTFTrue').value || '‡¶∏‡¶§‡ßç‡¶Ø';
    const falseLabel = document.getElementById('qTFFalse').value || '‡¶Æ‡¶ø‡¶•‡ßç‡¶Ø‡¶æ';
    const correctVal = document.getElementById('qTFCorrect').value; // '‡¶∏‡¶§‡ßç‡¶Ø' ‡¶¨‡¶æ '‡¶Æ‡¶ø‡¶•‡ßç‡¶Ø‡¶æ'
    payload = {...payload,
      option_a: trueLabel,
      option_b: falseLabel,
      correct_answer: correctVal,
      question_order: parseInt(document.getElementById('qTFOrder').value)||1 };

  } else if (type === 'fillinblank') {
    const a=document.getElementById('qFIBA').value.trim();
    const b=document.getElementById('qFIBB').value.trim();
    if(!a||!b){ showAlert('addQError','‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß®‡¶ü‡¶ø ‡¶Ö‡¶™‡¶∂‡¶® ‡¶¶‡¶ø‡¶®'); return; }
    const correctText = document.getElementById('qFIBCorrect').value.trim();
    if(!correctText){ showAlert('addQError','‡¶∏‡¶†‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®'); return; }
    payload = {...payload,
      option_a: a, option_b: b,
      option_c: document.getElementById('qFIBC').value.trim()||null,
      option_d: document.getElementById('qFIBD').value.trim()||null,
      correct_answer: correctText,
      question_order: parseInt(document.getElementById('qFIBOrder').value)||1 };
  }

  loading(true);
  const {error} = await sb.from('questions').insert(payload);
  loading(false);
  if(error){ showAlert('addQError','‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: '+error.message); return; }

  ['qText','qA','qB','qC','qD','qFIBA','qFIBB','qFIBC','qFIBD','qFIBCorrect'].forEach(id => {
    const el = document.getElementById(id); if(el) el.value='';
  });
  closeModal('addQuestionModal');
  loadQuestions();
}

async function deleteQuestion(id) {
  if(!confirm('‡¶è‡¶á ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?')) return;
  await sb.from('questions').delete().eq('id',id);
  loadQuestions();
}

// ‚îÄ‚îÄ RESULTS ‚îÄ‚îÄ
async function loadResultFilters() {
  const {data} = await sb.from('exams').select('id,title,class,batch').order('created_at',{ascending:false});
  const sel = document.getElementById('resultExamFilter');
  sel.innerHTML = '<option value="">‡¶∏‡¶¨ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ</option>';
  (data||[]).forEach(e=>{ sel.innerHTML += `<option value="${e.id}">${e.title} (‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ${e.class}, Batch ${e.batch||'A'})</option>`; });
  loadResults();
}

async function loadResults() {
  const examId = document.getElementById('resultExamFilter').value;
  const cls = document.getElementById('resultClassFilter').value;
  let q = sb.from('results').select('*, students(name,class,roll,batch), exams(title,batch)').order('submitted_at',{ascending:false}).limit(100);
  if(examId) q = q.eq('exam_id',examId);
  const {data} = await q;
  let rows = data||[];
  if(cls) rows = rows.filter(r=>r.students?.class===cls);
  const sorted = rows.sort((a,b)=>b.score-a.score);
  const wrap = document.getElementById('resultsTable');
  if(!rows.length){wrap.innerHTML='<p style="padding:1rem;color:var(--text-muted)">‡¶ï‡ßã‡¶®‡ßã ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶®‡ßá‡¶á</p>';return;}
  wrap.innerHTML = `<table><thead><tr><th>#</th><th>‡¶®‡¶æ‡¶Æ</th><th>‡¶ï‡ßç‡¶≤‡¶æ‡¶∏</th><th>‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö</th><th>‡¶∞‡ßã‡¶≤</th><th>‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ</th><th>‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</th><th>‡¶∂‡¶§‡¶æ‡¶Ç‡¶∂</th><th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th></tr></thead>
  <tbody>${sorted.map((r,i)=>`<tr>
    <td>${i+1}</td>
    <td>${r.students?.name||'-'}</td>
    <td><span class="badge badge-class">${r.students?.class||'-'}</span></td>
    <td><span class="badge" style="background:rgba(245,158,11,0.15);color:#FCD34D">Batch ${r.students?.batch||'-'}</span></td>
    <td>${r.students?.roll||'-'}</td>
    <td style="font-size:0.8rem">${r.exams?.title||'-'}</td>
    <td><strong>${r.score}/${r.total_questions}</strong></td>
    <td>${Math.round(r.score/r.total_questions*100)}%</td>
    <td>${new Date(r.submitted_at).toLocaleDateString('bn-BD')}</td>
  </tr>`).join('')}</tbody></table>`;
}

// ‚îÄ‚îÄ MERIT ‚îÄ‚îÄ
async function loadAdminMerit() {
  const cls = document.getElementById('meritClassFilter').value;
  const batch = document.getElementById('meritBatchFilter').value;
  const month = document.getElementById('meritMonthFilter').value;
  const {data} = await sb.from('monthly_merit').select('*').eq('class',cls).eq('batch',batch).eq('month',month).order('merit_position');
  const wrap = document.getElementById('meritTable');
  if(!data||!data.length){wrap.innerHTML='<p style="padding:1rem;color:var(--text-muted)">‡¶ï‡ßã‡¶®‡ßã ‡¶§‡¶•‡ßç‡¶Ø ‡¶®‡ßá‡¶á</p>';return;}
  wrap.innerHTML = `<table><thead><tr><th>‡¶∏‡ßç‡¶•‡¶æ‡¶®</th><th>‡¶®‡¶æ‡¶Æ</th><th>‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö</th><th>‡¶∞‡ßã‡¶≤</th><th>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th><th>‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ</th><th>‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</th><th>‡¶∂‡¶§‡¶æ‡¶Ç‡¶∂</th></tr></thead>
  <tbody>${data.map(r=>`<tr>
    <td><strong>${r.merit_position}</strong></td>
    <td>${r.name}</td>
    <td><span class="badge" style="background:rgba(245,158,11,0.15);color:#FCD34D">Batch ${r.batch}</span></td>
    <td>${r.roll}</td>
    <td>${r.phone||'-'}</td>
    <td>${r.exams_taken}</td>
    <td>${r.total_score}/${r.total_possible}</td>
    <td><strong>${r.percentage}%</strong></td>
  </tr>`).join('')}</tbody></table>`;
}

// INIT
window.addEventListener('load', () => {
  if(sessionStorage.getItem('adminLoggedIn')==='true'){
    document.getElementById('adminLoginWrap').style.display='none';
    document.getElementById('adminApp').style.display='flex';
    loadDashboard();
  }
});
</script>
</body>
</html>
